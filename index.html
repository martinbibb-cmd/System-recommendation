<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>System Recommendation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f8fafc;
      --fg: #0f172a;
      --card: #ffffff;
      --border: #e2e8f0;
      --accent: #0ea5e9;
      --muted: #64748b;
      --good: #22c55e;
      --warn: #f97316;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: .75rem 1rem .5rem;
      text-align: center;
      background: #fff;
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }
    header small {
      display: block;
      font-size: .65rem;
      color: var(--muted);
    }
    .top-actions {
      position: absolute;
      right: 1rem;
      top: .55rem;
      display: flex;
      gap: .4rem;
    }
    .btn {
      background: var(--accent);
      border: none;
      color: #fff;
      padding: .35rem .6rem;
      border-radius: .5rem;
      font-size: .63rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn.secondary {
      background: #fff;
      border: 1px solid var(--border);
      color: #0f172a;
    }
    main {
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      flex: 1;
      min-height: 0;
    }
    aside {
      background: #f1f5f9;
      border-right: 1px solid var(--border);
      padding: .5rem .5rem 3rem;
      overflow-y: auto;
    }
    .nav-title {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .04em;
      margin: .5rem 0 .25rem;
      color: #475569;
    }
    .panel {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: .6rem;
      margin-bottom: .5rem;
      padding: .5rem .5rem .25rem;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: .2rem;
      font-size: .65rem;
      margin-bottom: .35rem;
    }
    label.checkbox {
      flex-direction: row;
      align-items: center;
      gap: .45rem;
      font-size: .6rem;
      color: #0f172a;
    }
    label.checkbox span {
      flex: 1;
      line-height: 1.3;
    }
    select, input {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: .4rem;
      padding: .25rem .35rem;
      font-size: .65rem;
    }
    input[type="checkbox"] {
      width: .75rem;
      height: .75rem;
      border-radius: .2rem;
      margin: 0;
    }
    #right {
      padding: .5rem .75rem 1rem;
      overflow-y: auto;
    }
    #summary-section {
      margin-top: .75rem;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: .6rem;
      padding: .6rem .75rem;
    }
    #summary-section h2 {
      margin: 0 0 .35rem;
      font-size: .6rem;
      letter-spacing: .02em;
      text-transform: uppercase;
      color: var(--muted);
    }
    /* list view */
    .result-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: .6rem;
      padding: .6rem .7rem;
      margin-bottom: .6rem;
      display: flex;
      gap: .75rem;
      font-size: 22pt; /* per request */
      line-height: 1.3;
      align-items: flex-start;
    }
    .result-image {
      width: 140px;
      border: 1px solid #dbeafe;
      background: #eff6ff;
      border-radius: .6rem;
      flex: 0 0 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: .35rem;
      font-size: .5em;
      color: #475569;
      text-align: center;
      padding: .45rem;
    }
    .result-image img {
      width: 100%;
      height: auto;
      border-radius: .4rem;
      object-fit: contain;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      background: #fff;
    }
    .result-image-label {
      display: flex;
      flex-direction: column;
      gap: .1rem;
      font-size: .45em;
      line-height: 1.25;
    }
    .result-image-boiler {
      font-weight: 700;
      letter-spacing: .01em;
    }
    .result-image-water {
      color: #64748b;
      font-weight: 500;
    }
    .result-body {
      flex: 1;
      min-width: 0;
    }
    .result-header {
      display: flex;
      gap: .5rem;
      align-items: center;
      margin-bottom: .25rem;
    }
    .result-title {
      font-weight: 700;
      font-size: .55em;
    }
    .tick {
      width: 1.3em;
      height: 1.3em;
      border-radius: 9999px;
      background: #e2e8f0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .45em;
      flex: 0 0 auto;
    }
    .tick.active {
      background: #dcfce7;
      color: #166534;
      border: .1em solid #22c55e;
    }
    .why {
      font-size: .45em;
      margin-bottom: .35rem;
      color: #0f172a;
    }
    .list-cols {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .pros, .cons {
      font-size: .45em;
      min-width: 220px;
    }
    .pros h4, .cons h4 {
      margin: 0 0 .2rem;
      font-size: .7em;
    }
    .pros ul, .cons ul {
      margin: 0;
      padding-left: 1.1rem;
    }
    .pros li, .cons li {
      margin-bottom: .15rem;
    }
    .highlight {
      background: #fef3c7;
      border-radius: .3rem;
      padding: .05rem .35rem;
    }
    #summary-disclaimer {
      font-size: .38em;
      color: #475569;
      margin-top: .4rem;
    }
    .recommendation-card {
      background: linear-gradient(135deg, #e0f2fe, #f8fafc);
      border: 1px solid #bae6fd;
      border-radius: .8rem;
      padding: .7rem .8rem;
      margin-bottom: .6rem;
      font-size: 22pt;
      display: flex;
      flex-direction: column;
      gap: .45rem;
    }
    .recommendation-card header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: .75rem;
      font-size: .55em;
      font-weight: 600;
    }
    .recommendation-card header span {
      color: #0369a1;
      font-size: .55em;
    }
    .recommendation-name {
      font-size: .65em;
      font-weight: 700;
      color: #0f172a;
    }
    .recommendation-summary {
      font-size: .45em;
      color: #0f172a;
      margin-top: .1rem;
    }
    .recommendation-score {
      background: #0369a1;
      color: #e0f2fe;
      border-radius: 999px;
      padding: .15rem .55rem;
      font-size: .45em;
      font-weight: 600;
    }
    .recommendation-card section {
      font-size: .48em;
      display: grid;
      gap: .35rem;
    }
    .recommendation-card ul {
      margin: 0;
      padding-left: 1.1rem;
    }
    .recommendation-card li {
      margin-bottom: .15rem;
    }
    .recommendation-alternatives li {
      display: flex;
      justify-content: space-between;
      gap: .5rem;
    }
    .recommendation-alt-score {
      color: #0369a1;
      font-variant-numeric: tabular-nums;
    }
    @media (max-width: 950px) {
      main { grid-template-columns: 1fr; }
      .result-card { flex-direction: column; }
      .result-image { width: 100%; }
      .top-actions { position: static; justify-content: center; margin-top: .4rem; }
      header { padding-top: 2.2rem; }
    }
    @media print {
      header, aside, .top-actions { display: none !important; }
      main { grid-template-columns: 1fr !important; }
      body { background: #fff; }
    }
  </style>
</head>
<body>
  <header>
    <div class="top-actions">
      <button class="btn secondary" id="btn-export-data">Data CSV</button>
      <button class="btn secondary" id="btn-export-sources">Sources CSV</button>
      <button class="btn" id="btn-print">Print / PDF</button>
    </div>
    <h1>Which system is best for you?</h1>
    <small>UK, evidence-based, illustrative only.</small>
  </header>
  <main>
    <aside>
      <div class="nav-title">About you</div>
      <div class="panel">
        <label>
          House type
          <select id="houseType">
            <option value="flat/bungalow">Flat / Bungalow</option>
            <option value="terraced">Terraced</option>
            <option value="semi" selected>Semi-detached</option>
            <option value="detached">Detached</option>
          </select>
        </label>
        <label>
          Bedrooms
          <select id="bedrooms">
            <option>1</option>
            <option>2</option>
            <option selected>3</option>
            <option>4</option>
            <option>5</option>
          </select>
        </label>
        <label>
          Bathrooms
          <select id="bathrooms">
            <option>1</option>
            <option selected>2</option>
            <option>3</option>
          </select>
        </label>
        <label>
          People in home
          <select id="occupants">
            <option>1</option>
            <option>2</option>
            <option selected>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
          </select>
        </label>
        <label>
          Hot draws per day
          <input type="number" id="drawsPerDay" value="22" min="5" max="60" />
          <small style="color:#94a3b8;">Auto-adjusts with people, can override.</small>
        </label>
      </div>

      <div class="nav-title">Current system</div>
      <div class="panel">
        <label>
          Boiler type
          <select id="currentBoiler">
            <option value="regular">Regular</option>
            <option value="system">System</option>
            <option value="combi" selected>Combi</option>
          </select>
        </label>
        <label>
          Water
          <select id="currentWater">
            <option value="open_vented">Open vented</option>
            <option value="mixergy_open">Mixergy open vented</option>
            <option value="unvented">Unvented</option>
            <option value="mixergy_unvented">Mixergy unvented</option>
            <option value="thermal_store">Thermal store</option>
            <option value="on_demand">On demand</option>
          </select>
        </label>
      </div>

      <div class="nav-title">Installation preferences</div>
      <div class="panel">
        <label class="checkbox">
          <input type="checkbox" id="prefKeepCylinder" checked />
          <span>Prefer to keep or install a hot-water cylinder</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" id="prefConvertToSealed" />
          <span>Considering conversion from open-vented to sealed/unvented</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" id="prefHighOutput" />
          <span>High-output boiler (≥30&nbsp;kW) expected</span>
        </label>
      </div>

      <div class="nav-title">Potential solution A</div>
      <div class="panel">
        <label>
          Boiler
          <select id="newABoiler">
            <option value="regular">Regular</option>
            <option value="system">System</option>
            <option value="combi" selected>Combi</option>
          </select>
        </label>
        <label>
          Water
          <select id="newAWater">
            <option value="open_vented">Open vented</option>
            <option value="mixergy_open">Mixergy open vented</option>
            <option value="unvented">Unvented</option>
            <option value="mixergy_unvented">Mixergy unvented</option>
            <option value="on_demand">On demand</option>
          </select>
        </label>
      </div>

      <div class="nav-title">Potential solution B</div>
      <div class="panel">
        <label>
          Boiler
          <select id="newBBoiler">
            <option value="regular">Regular</option>
            <option value="system">System</option>
            <option value="combi">Combi</option>
          </select>
        </label>
        <label>
          Water
          <select id="newBWater">
            <option value="open_vented">Open vented</option>
            <option value="mixergy_open">Mixergy open vented</option>
            <option value="unvented">Unvented</option>
            <option value="mixergy_unvented">Mixergy unvented</option>
            <option value="on_demand">On demand</option>
          </select>
        </label>
      </div>
    </aside>

    <div id="right">
      <!-- results will be injected here -->
      <div id="results"></div>
      <section id="summary-section">
        <h2>Summary</h2>
        <div id="summary"></div>
      </section>
      <div id="summary-disclaimer">
        This illustration is for guidance only and does not constitute financial advice, a quotation, or a heating system design.
        Figures are derived from UK field research (2015–2025) on domestic water use, DHW efficiency, combi lag, cylinder losses, and installer-reported performance.
        Values are indicative and should be confirmed by an on-site survey.
      </div>
    </div>
  </main>

  <script>
    // data (same as before, trimmed for brevity)
    const boilerLabels = {
      regular: "Regular",
      system: "System",
      combi: "Combi"
    };

    const boilerImages = {
      regular: "Data/Open-vented-schematic.jpeg",
      system: "Data/System-boiler.png",
      combi: "Data/Combination.png"
    };

    const waterLabels = {
      open_vented: "Open vented",
      mixergy_open: "Mixergy open vented",
      unvented: "Unvented",
      mixergy_unvented: "Mixergy unvented",
      thermal_store: "Thermal store",
      on_demand: "On demand"
    };

    function togglePanelByHeading(headingText, show) {
      const selectors = "h1, h2, h3, h4, legend, .section-title, .nav-title, strong";
      const targetText = headingText.trim().toLowerCase();
      document.querySelectorAll(selectors).forEach((heading) => {
        if (!heading.textContent) return;
        if (heading.textContent.trim().toLowerCase() !== targetText) return;

        const container = heading.closest(".panel, section, .card, .box, div");
        const displayValue = show ? "" : "none";

        if (container && container !== heading) {
          container.style.display = displayValue;
        } else {
          heading.style.display = displayValue;
        }

        if (heading.classList && heading.classList.contains("nav-title")) {
          const siblingPanel = heading.nextElementSibling;
          if (siblingPanel && siblingPanel.classList.contains("panel")) {
            siblingPanel.style.display = displayValue;
          }
        }
      });
    }

    function applySystemRecUI(result, inputs) {
      togglePanelByHeading("Installation preferences", false);
      togglePanelByHeading("Mixergy cylinder", false);
      togglePanelByHeading("Key points", false);
      togglePanelByHeading("Other sources", false);

      const type = result && result.recommended;

      if (type === "combi") {
        togglePanelByHeading("Installation preferences", true);
        togglePanelByHeading("Gas supply / pipe sizing", true);
      }

      if (type === "system") {
        togglePanelByHeading("Installation preferences", true);
      }

      if (type === "mixergy" || (inputs && inputs.keepCylinder)) {
        togglePanelByHeading("Mixergy cylinder", true);
      }

      if (type === "regular") {
        togglePanelByHeading("Installation preferences", false);
      }

      if (result && Array.isArray(result.notes) && result.notes.length) {
        togglePanelByHeading("Key points", true);
      }
    }

    const systemData = {
      combi: {
        baseWaste: {
          "flat/bungalow": 1,
          "terraced": 5.5,
          "semi": 5.5,
          "detached": 8
        },
        baseWait: {
          "flat/bungalow": 20,
          "terraced": 45,
          "semi": 45,
          "detached": 90
        },
        startupKWh: 0.025,
        postPurgeKWh: 0.015
      },
      stored: {
        wastePerDraw: 1.5,
        wait: 10,
        cylLoss: 1.5
      }
    };

    const sourcesList = [
      "Energy Saving Trust / BEIS domestic HW studies (2016–2023)",
      "SAP / BRE space & water efficiency assumptions",
      "Waterwise / OFWAT UK household water use",
      "Installer field data on combi lag and post-purge",
      "UK open-vented vs sealed system practice"
    ];

    const SYSTEM_REC_MODELS = {
      meta: {
        version: "1.1",
        description: "Conditional notes for system recommendations"
      },
      efficiency: {
        combi: { base: 0.90, lowOccupancyBonus: 0.05, highUsagePenalty: -0.20 },
        system: { base: 0.94 },
        regular: { base: 0.93 },
        mixergy: { base: 0.94 }
      },
      longevity: {
        combi: 0.9,
        system: 1.1,
        regular: 1.0,
        mixergy: 1.3
      },
      text: {
        combi_small_house: "Combi is suitable for smaller households using one outlet at a time.",
        combi_multi_outlet_limit: "Combi hot water is priority-fed – running more than one outlet will reduce flow/temperature.",
        combi_bigger_gas: "Combi will require a larger gas supply than a typical 15 kW regular boiler.",
        sealed_conversion: "Sealing the system can expose existing weeps/leaks in older pipework and radiators.",
        cylinder_future: "Keeping a cylinder supports future heat pump or solar PV options and gives immersion back-up.",
        condensing_eff: "System/cylinder setups keep efficiency close to 94% in real use.",
        open_vent_kept: "Regular boiler retains open-vented arrangement (no new sealed components) unless specified."
      }
    };

    function boilerImpliesSealed(type) {
      return type === "combi" || type === "system";
    }

    function waterIsOpenVented(type) {
      return type === "open_vented" || type === "mixergy_open";
    }

    function getSystemRecommendation(inputs) {
      const eff = SYSTEM_REC_MODELS.efficiency;
      const lon = SYSTEM_REC_MODELS.longevity;
      const txt = SYSTEM_REC_MODELS.text;

      const occ = inputs.occupants || 2;
      const baths = inputs.bathrooms || 1;
      const convertToSealed = Boolean(inputs.convertToSealed);
      const currentIsOpen = waterIsOpenVented(inputs.currentWater);
      const shouldWarnAboutSealing = convertToSealed || currentIsOpen;

      const scores = {
        combi: eff.combi.base,
        system: eff.system.base,
        regular: eff.regular.base,
        mixergy: eff.mixergy.base
      };

      if (occ <= 2 && baths === 1) {
        scores.combi += eff.combi.lowOccupancyBonus;
      } else {
        scores.combi += eff.combi.highUsagePenalty;
        scores.system += 0.05;
        scores.mixergy += 0.05;
      }

      if (inputs.keepCylinder) {
        scores.system *= lon.system;
        scores.mixergy *= lon.mixergy;
        scores.regular *= lon.regular;
      }

      let bestKey;
      if (inputs.wantedType && scores[inputs.wantedType] !== undefined) {
        bestKey = inputs.wantedType;
      } else {
        bestKey = Object.keys(scores).sort((a, b) => scores[b] - scores[a])[0];
      }

      const notes = [];

      if (bestKey === "combi") {
        notes.push(txt.combi_small_house);
        notes.push(txt.combi_multi_outlet_limit);
        notes.push(txt.combi_bigger_gas);
        if (shouldWarnAboutSealing) {
          notes.push(txt.sealed_conversion);
        }
      }

      if (bestKey === "system") {
        if (shouldWarnAboutSealing) {
          notes.push(txt.sealed_conversion);
        }
        if (inputs.keepCylinder) {
          notes.push(txt.cylinder_future);
          notes.push(txt.condensing_eff);
        }
      }

      if (bestKey === "regular") {
        if (convertToSealed || boilerImpliesSealed(inputs.wantedType)) {
          notes.push(txt.sealed_conversion);
        } else {
          notes.push(txt.open_vent_kept);
        }
      }

      if (bestKey === "mixergy") {
        notes.push(txt.cylinder_future);
        notes.push(txt.condensing_eff);
      }

      if (inputs.highOutput && bestKey !== "combi") {
        notes.push("This appliance size may require upsizing the gas pipe back to the meter.");
      }

      const alternatives = Object.fromEntries(
        Object.entries(scores).filter(([key]) => key !== bestKey)
      );

      return {
        recommended: bestKey,
        score: scores[bestKey],
        alternatives,
        notes,
        rawScores: scores
      };
    }

    function getRecommendedDraws(people) {
      const p = Number(people);
      if (p <= 1) return 12;
      if (p === 2) return 18;
      if (p === 3) return 22;
      if (p === 4) return 26;
      if (p === 5) return 30;
      return 34;
    }

    function evaluateOption({houseType, occupants, bathrooms, drawsPerDay, currentBoiler, currentWater, newBoiler, newWater}) {
      const isCombi = newBoiler === "combi";
      const isStored = newWater === "unvented" || newWater === "mixergy_unvented" || newWater === "open_vented" || newWater === "mixergy_open" || newWater === "on_demand";
      const isCurrentStored = currentWater !== "on_demand" && currentWater !== "unvented" ? true : (currentWater !== "on_demand");
      const isCurrentOpen = currentWater === "open_vented" || currentWater === "mixergy_open";

      let score = 0;
      let dailyWasteL = 0;
      let dailyOverheadKWh = 0;
      let dailyCylinderLoss = 0;
      let extraCost = 0;
      const pros = [];
      const cons = [];
      const relevant = new Set();

      // performance
      if (isCombi) {
        const wastePerDraw = systemData.combi.baseWaste[houseType] ?? 5.5;
        const wait = systemData.combi.baseWait[houseType] ?? 45;
        dailyWasteL = wastePerDraw * drawsPerDay;
        dailyOverheadKWh = (systemData.combi.startupKWh + systemData.combi.postPurgeKWh) * drawsPerDay;
        pros.push("Single appliance, frees space");
        cons.push(`Hot water lag ${wait}s to tap`);
        cons.push(`Wastes about ${wastePerDraw.toFixed(1)} L per draw (${dailyWasteL.toFixed(1)} L/day)`);
        cons.push(`Per-draw energy overhead ≈ ${dailyOverheadKWh.toFixed(2)} kWh/day`);
        // suitability
        if (occupants <= 3 && bathrooms <= 2) {
          score += 3;
          relevant.add("pros:Single appliance, frees space");
        } else {
          score -= 2;
          relevant.add(`cons:Hot water lag ${wait}s to tap`);
        }
      } else {
        // stored / cylinder
        dailyWasteL = systemData.stored.wastePerDraw * drawsPerDay;
        dailyCylinderLoss = systemData.stored.cylLoss;
        pros.push("Shorter tap-to-hot, better comfort");
        pros.push("Longer boiler burns → better modulation");
        cons.push(`Cylinder standing loss ≈ ${dailyCylinderLoss.toFixed(1)} kWh/day`);
        score += 3;
        if (occupants >= 4 || bathrooms >= 2) {
          pros.push("Better for multiple/simultaneous draws");
          score += 2;
          relevant.add("pros:Better for multiple/simultaneous draws");
        }
      }

      // cost / disruption
      // 1) open vented → unvented
      if (isCurrentOpen && (newWater === "unvented" || newWater === "mixergy_unvented")) {
        extraCost += 2000;
        cons.push("Open-vented → unvented typically adds ~£2000");
        score -= 1;
        relevant.add("cons:Open-vented → unvented typically adds ~£2000");
      }
      // 2) stored → combi (actual UK reality: +£1500)
      if (newBoiler === "combi" && currentBoiler !== "combi") {
        extraCost += 1500;
        cons.push("Converting to a combi from stored is often £1200–£1800 extra (pipework, cylinder removal)");
        score -= 1;
        relevant.add("cons:Converting to a combi from stored is often £1200–£1800 extra (pipework, cylinder removal)");
      }
      // 3) like-for-like
      if (newBoiler === currentBoiler && newWater === currentWater) {
        pros.push("Like-for-like keeps cost and disruption low");
        score += 2;
        relevant.add("pros:Like-for-like keeps cost and disruption low");
      }

      return {
        score,
        dailyWasteL,
        dailyOverheadKWh,
        dailyCylinderLoss,
        extraCost,
        pros,
        cons,
        relevant
      };
    }

    async function render() {
      const houseType = document.getElementById("houseType").value;
      const bedrooms = document.getElementById("bedrooms").value;
      const bathrooms = parseInt(document.getElementById("bathrooms").value, 10);
      const occupants = parseInt(document.getElementById("occupants").value, 10);
      const drawsInput = parseInt(document.getElementById("drawsPerDay").value, 10);
      const drawsPerDay = Number.isFinite(drawsInput) ? drawsInput : getRecommendedDraws(occupants);
      const currentBoiler = document.getElementById("currentBoiler").value;
      const currentWater = document.getElementById("currentWater").value;
      const keepCylinder = document.getElementById("prefKeepCylinder").checked;
      const convertToSealed = document.getElementById("prefConvertToSealed").checked;
      const highOutput = document.getElementById("prefHighOutput").checked;
      const newABoiler = document.getElementById("newABoiler").value;
      const newAWater = document.getElementById("newAWater").value;
      const newBBoiler = document.getElementById("newBBoiler").value;
      const newBWater = document.getElementById("newBWater").value;

      const systemRecommendation = getSystemRecommendation({
        occupants,
        bathrooms,
        keepCylinder,
        convertToSealed,
        highOutput,
        currentWater
      });

      const evalA = evaluateOption({houseType, occupants, bathrooms, drawsPerDay, currentBoiler, currentWater, newBoiler:newABoiler, newWater:newAWater});
      const evalB = evaluateOption({houseType, occupants, bathrooms, drawsPerDay, currentBoiler, currentWater, newBoiler:newBBoiler, newWater:newBWater});

      // pick best
      const options = [
        {
          id: "A",
          title: `Option A: ${formatBoilerName(newABoiler)} + ${formatWaterName(newAWater)}`,
          boiler: newABoiler,
          boilerLabel: formatBoilerName(newABoiler),
          water: newAWater,
          waterLabel: formatWaterName(newAWater),
          ...evalA
        },
        {
          id: "B",
          title: `Option B: ${formatBoilerName(newBBoiler)} + ${formatWaterName(newBWater)}`,
          boiler: newBBoiler,
          boilerLabel: formatBoilerName(newBBoiler),
          water: newBWater,
          waterLabel: formatWaterName(newBWater),
          ...evalB
        }
      ].sort((a,b) => b.score - a.score); // best first

      const bestId = options[0].id;

      const resultsDiv = document.getElementById("results");
      const recommendationHtml = makeSystemRecommendationCard(systemRecommendation);
      const optionsHtml = options.map(opt => {
        const why = makeWhyText(opt, occupants, bathrooms);
        return makeResultCard(opt, why, opt.id === bestId);
      }).join("");
      resultsDiv.innerHTML = recommendationHtml + optionsHtml;

      applySystemRecUI(systemRecommendation, {
        occupants,
        bathrooms,
        keepCylinder,
        convertToSealed,
        highOutput
      });

      const bestOption = options[0];
      hideMixergyCard();
      renderSummary({
        boiler: systemRecommendation && systemRecommendation.recommended,
        water: bestOption && bestOption.water
      });
    }

    function makeWhyText(opt, occupants, bathrooms) {
      // short explanation
      if (opt.boiler === "combi") {
        if (occupants <= 3 && bathrooms <= 2) {
          return "Works for your size household, but expect some hot-water lag and per-draw energy overhead.";
        }
        return "Will work, but your usage suggests stored water would reduce lag and wasted water.";
      } else {
        return "Stored hot water suits your household because it reduces wait time and copes better with multiple uses.";
      }
    }

    function makeResultCard(opt, why, isBest) {
      // highlight relevant pros/cons
      const prosHtml = opt.pros.map(p => {
        const key = "pros:" + p;
        return `<li${opt.relevant.has(key) ? ' class="highlight"' : ''}>${p}</li>`;
      }).join("");
      const consHtml = opt.cons.map(c => {
        const key = "cons:" + c;
        return `<li${opt.relevant.has(key) ? ' class="highlight"' : ''}>${c}</li>`;
      }).join("");

      return `
      <div class="result-card">
        <div class="result-image">
          ${renderBoilerImage(opt)}
          <div class="result-image-label">
            <span class="result-image-boiler">${opt.boilerLabel}</span>
            <span class="result-image-water">${opt.waterLabel}</span>
          </div>
        </div>
        <div class="result-body">
          <div class="result-header">
            <div class="tick ${isBest ? 'active' : ''}">${isBest ? '✓' : ''}</div>
            <div class="result-title">${opt.title}</div>
          </div>
          <div class="why">${why}</div>
          <div class="list-cols">
            <div class="pros">
              <h4>Pros</h4>
              <ul>
                ${prosHtml || "<li>No major pros recorded.</li>"}
              </ul>
            </div>
            <div class="cons">
              <h4>Cons</h4>
              <ul>
                ${consHtml || "<li>No major cons recorded.</li>"}
              </ul>
            </div>
          </div>
        </div>
      </div>
      `;
    }

    function renderBoilerImage(opt) {
      const src = boilerImages[opt.boiler];
      if (!src) {
        return "";
      }
      const alt = `${opt.boilerLabel} boiler illustration`;
      return `<img src="${src}" alt="${alt}" />`;
    }

    const recommendationLabels = {
      combi: "Combi boiler",
      system: "System boiler + cylinder",
      regular: "Regular boiler + vented cylinder",
      mixergy: "Mixergy smart cylinder"
    };

    const recommendationSummaries = {
      combi: "Single appliance, best where demand is modest.",
      system: "Sealed system with unvented storage for higher draw homes.",
      regular: "Retains vented cylinder and header tanks.",
      mixergy: "Smart cylinder ready for PV / heat-pump integration."
    };

    function formatBoilerName(value) {
      return boilerLabels[value] || value;
    }

    function formatWaterName(value) {
      return waterLabels[value] || value.replace(/_/g, " ");
    }

    function formatRecommendationName(key) {
      return recommendationLabels[key] || key;
    }

    function makeSystemRecommendationCard(rec) {
      const name = formatRecommendationName(rec.recommended);
      const summary = recommendationSummaries[rec.recommended];
      const score = rec.score.toFixed(2);
      const notesHtml = (rec.notes || []).map(n => `<li>${n}</li>`).join("");
      const alternatives = Object.entries(rec.alternatives || {})
        .sort((a, b) => b[1] - a[1]);
      const altHtml = alternatives.map(([key, value]) => {
        return `<li><span>${formatRecommendationName(key)}</span><span class="recommendation-alt-score">${value.toFixed(2)}</span></li>`;
      }).join("");

      return `
        <article class="recommendation-card">
          <header>
            <div>
              <div class="recommendation-name">${name}</div>
              ${summary ? `<div class="recommendation-summary">${summary}</div>` : ""}
            </div>
            <span class="recommendation-score">Score ${score}</span>
          </header>
          <section>
            ${notesHtml ? `<div><strong>Key points</strong><ul>${notesHtml}</ul></div>` : ""}
            ${altHtml ? `<div class="recommendation-alternatives"><strong>Other scores</strong><ul>${altHtml}</ul></div>` : ""}
          </section>
        </article>
      `;
    }

    function findSummaryContainer() {
      let el = document.getElementById("summary");
      if (el) return el;

      const headings = document.querySelectorAll("#right h1, #right h2, #right h3, #right h4");
      for (const heading of headings) {
        if (heading.textContent && heading.textContent.toLowerCase().includes("summary")) {
          return heading.parentElement || heading;
        }
      }
      return document.body;
    }

    function hideMixergyCard() {
      const blocks = document.querySelectorAll("div, section, article");
      blocks.forEach((el) => {
        if (!el || !el.textContent) return;
        if (el.textContent.includes("Mixergy smart cylinder")) {
          el.style.display = "none";
        }
      });
    }

    function buildSummaryText(sel) {
      const selection = sel || {};
      const boiler = (selection.boiler || "").toLowerCase();
      const water = (selection.water || "").toLowerCase();
      const lines = [];

      // COMBI ---------------------------------------------------------
      if (boiler === "combi") {
        lines.push("**Selected system:** Combi boiler with on-demand hot water.");
        lines.push("");
        lines.push("**Requirements:**");
        lines.push("- Larger gas supply than a typical 15 kW regular boiler may be required to maintain working pressure.");
        lines.push("- System will be sealed/high pressure (expansion vessel, PRV, gauge, filling loop).");
        lines.push("- Condensate route must be protected (may need extra labour to box/extend or pump).");
        lines.push("");
        lines.push("**Risks / implications:**");
        lines.push("- Converting from open vent to sealed can expose existing minor leaks or weeps in old pipework/radiators.");
        lines.push("- DHW is priority-fed: designed for **one tap/shower at a time**. Running multiple outlets will reduce flow/temperature.");
        lines.push("- Actual hot water flow is limited by incoming mains pressure/flow and winter mains temperature.");
        lines.push("");
        lines.push("**Efficiency & future-proofing:**");
        lines.push("- Best in small/medium households with single-outlet use.");
        lines.push("- No stored cylinder, so fewer options later for heat pump or PV dump.");
        lines.push("");
        lines.push("**Customer advised:**");
        lines.push("- Combi chosen instead of stored hot water: performance depends on mains and single-outlet use.");
        lines.push("- Sealed system may show up existing leaks; remedial work may be needed.");
        lines.push("- Gas pipe may need upsizing — to be confirmed on installation.");
        return lines.join("\n");
      }

      // SYSTEM (unvented/vented with system boiler) -------------------
      if (boiler === "system") {
        lines.push("**Selected system:** System boiler with stored hot water.");
        lines.push("");
        lines.push("**Requirements:**");
        lines.push("- System boiler runs as a **sealed/high-pressure system** (expansion, PRV, filling loop).");
        lines.push("- Cylinder to be retained/installed; immersion supply recommended.");
        lines.push("- Condensate route to be confirmed/protected.");
        lines.push("");
        lines.push("**Risks / implications:**");
        lines.push("- Pressurising an older, previously open-vented system can expose weeps/leaks at valves, rads and joints.");
        lines.push("- Access may be needed for cylinder controls/safety devices.");
        lines.push("");
        lines.push("**Efficiency & future-proofing:**");
        lines.push("- Stored/system setups tend to stay close to **≈94%** in real use because the boiler condenses longer.");
        lines.push("- Keeping a cylinder supports future **heat pump** or **PV + immersion** integration and gives hot-water back-up.");
        lines.push("");
        lines.push("**Customer advised:**");
        lines.push("- System will now be sealed/high pressure; minor existing leaks may become visible.");
        lines.push("- Cylinder gives more reliable hot water for higher usage or multiple bathrooms.");
        return lines.join("\n");
      }

      // REGULAR (open vented) -----------------------------------------
      if (boiler === "regular" && (water.includes("open") || water.includes("vented"))) {
        lines.push("**Selected system:** Regular (heat-only) boiler with **open-vented** cylinder.");
        lines.push("");
        lines.push("**Requirements:**");
        lines.push("- Existing F&E/vent arrangement to remain (no change to sealed components).");
        lines.push("- System clean/inhibit as per spec.");
        lines.push("");
        lines.push("**Risks / implications:**");
        lines.push("- Low-pressure/open-vented system, so the sealing/leak risk advice does **not** apply here.");
        lines.push("- Good choice where pipework/rads are old and you don’t want to pressurise them.");
        lines.push("");
        lines.push("**Efficiency & future-proofing:**");
        lines.push("- Less future-proof than a sealed cylinder for heat pump, unless upgraded later.");
        lines.push("- Cylinder still allows immersion back-up.");
        lines.push("");
        lines.push("**Customer advised:**");
        lines.push("- System kept open vented to avoid pressurising older pipework.");
        lines.push("- For future heat pump you would later need a suitable cylinder/sealed arrangement.");
        return lines.join("\n");
      }

      // REGULAR but NOT vented (edge) ---------------------------------
      if (boiler === "regular") {
        lines.push("**Selected system:** Regular (heat-only) boiler.");
        lines.push("");
        lines.push("**Requirements:**");
        lines.push("- Check whether system is to be sealed — if yes, expansion and PRV will be required.");
        lines.push("");
        lines.push("**Risks / implications:**");
        lines.push("- Sealing an older system can expose existing minor leaks.");
        return lines.join("\n");
      }

      // fallback ------------------------------------------------------
      return "**Summary:** Cylinder kept – supports future HP/PV, immersion backup, and keeps efficiency high.";
    }

    function renderSummary(selection) {
      const summaryContainer = findSummaryContainer();
      if (!summaryContainer) return;

      const text = buildSummaryText(selection);
      const boxId = "system-rec-summary-box";
      let box = document.getElementById(boxId);
      if (!box) {
        box = document.createElement("pre");
        box.id = boxId;
        box.style.whiteSpace = "pre-wrap";
        box.style.background = "rgba(0,0,0,0.03)";
        box.style.padding = "12px 14px";
        box.style.borderRadius = "8px";
        box.style.margin = "0";
        summaryContainer.appendChild(box);
      }
      box.textContent = text;
    }

    // events
    document.querySelectorAll("select,input").forEach(el => el.addEventListener("input", render));
    document.getElementById("occupants").addEventListener("input", e => {
      const rec = getRecommendedDraws(e.target.value);
      const draws = document.getElementById("drawsPerDay");
      draws.value = rec;
      render();
    });
    document.getElementById("btn-print").addEventListener("click", () => window.print());
    document.getElementById("btn-export-data").addEventListener("click", () => {
      alert("In this cut-down version, CSV export is stubbed. Use previous version's CSV section to keep data + sources.");
    });
    document.getElementById("btn-export-sources").addEventListener("click", () => {
      alert("Sources used:\n- " + sourcesList.join("\n- "));
    });

    render();
  </script>
</body>
</html>
