<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>System Recommendation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f0f4f8;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --fg: #1a202c;
      --card: #ffffff;
      --border: #e2e8f0;
      --accent: #667eea;
      --accent-hover: #5a67d8;
      --muted: #64748b;
      --good: #48bb78;
      --warn: #f6ad55;
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    * { box-sizing: border-box; }
    body, body * {
      font-size: 15.4pt !important;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 1.5rem 1rem 1rem;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: var(--shadow-lg);
      position: relative;
      color: white;
    }
    header h1 {
      margin: 0;
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.025em;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    header small {
      display: block;
      font-size: .7rem;
      color: rgba(255, 255, 255, 0.9);
      margin-top: 0.25rem;
      font-weight: 500;
    }
    .top-actions {
      position: absolute;
      right: 1rem;
      top: 1rem;
      display: flex;
      gap: .5rem;
    }
    .btn {
      background: rgba(255, 255, 255, 0.95);
      border: none;
      color: var(--accent);
      padding: .5rem .8rem;
      border-radius: .5rem;
      font-size: .63rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-md);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: rgba(255, 255, 255, 1);
    }
    .btn.secondary {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #fff;
    }
    .btn.secondary:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }
    main {
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      flex: 1;
      min-height: 0;
    }
    aside {
      background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
      border-right: 1px solid var(--border);
      padding: .75rem .75rem 3rem;
      overflow-y: auto;
    }
    .nav-title {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      margin: .75rem 0 .4rem;
      color: #475569;
      font-weight: 700;
    }
    .panel {
      background: #fff;
      border: none;
      border-radius: .75rem;
      margin-bottom: .75rem;
      padding: .75rem .75rem .5rem;
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease;
    }
    .panel:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-1px);
    }
    label {
      display: flex;
      flex-direction: column;
      gap: .3rem;
      font-size: .65rem;
      margin-bottom: .5rem;
      font-weight: 600;
      color: var(--fg);
    }
    select, input {
      background: #fff;
      border: 2px solid var(--border);
      border-radius: .5rem;
      padding: .4rem .5rem;
      font-size: .65rem;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    select:focus, input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    select:hover, input:hover {
      border-color: #cbd5e1;
    }
    #right {
      padding: .5rem .75rem 1rem;
      overflow-y: auto;
    }
    /* list view */
    .result-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: none;
      border-radius: 1rem;
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      line-height: 1.4;
      align-items: flex-start;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .result-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent) 0%, #764ba2 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .result-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }
    .result-card:hover::before {
      opacity: 1;
    }
    .result-image {
      width: 160px;
      border: none;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-radius: .75rem;
      flex: 0 0 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: .5rem;
      font-size: .5em;
      color: #475569;
      text-align: center;
      padding: .75rem;
      box-shadow: var(--shadow-sm);
    }
    .result-image img {
      width: 100%;
      height: auto;
      border-radius: .5rem;
      object-fit: contain;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
      background: #fff;
    }
    .result-image-label {
      display: flex;
      flex-direction: column;
      gap: .1rem;
      font-size: .45em;
      line-height: 1.25;
    }
    .result-image-boiler {
      font-weight: 700;
      letter-spacing: .01em;
    }
    .result-image-water {
      color: #64748b;
      font-weight: 500;
    }
    .result-body {
      flex: 1;
      min-width: 0;
    }
    .result-header {
      display: flex;
      gap: .5rem;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: .25rem;
    }
    .result-title {
      font-weight: 700;
      font-size: .55em;
      flex: 1;
      min-width: 160px;
    }
    .tick {
      width: 1.5em;
      height: 1.5em;
      border-radius: 9999px;
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .5em;
      flex: 0 0 auto;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }
    .tick.active {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: #fff;
      border: none;
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
      animation: tickPop 0.3s ease;
    }
    @keyframes tickPop {
      0% { transform: scale(0.8); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .why {
      font-size: .45em;
      margin-bottom: .35rem;
      color: #0f172a;
    }
    .read-aloud-btn {
      border: 2px solid var(--accent);
      background: #fff;
      color: var(--accent);
      font-size: .4em;
      font-weight: 600;
      border-radius: .5rem;
      padding: .35rem .55rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }
    .read-aloud-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .read-aloud-btn:hover {
      border-color: var(--accent-hover);
      background: linear-gradient(135deg, var(--accent) 0%, #764ba2 100%);
      color: #fff;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    .summary-actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: .35rem;
    }
    .result-content {
      width: 100%;
    }
    .list-cols {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .strengths, .limitations {
      font-size: .45em;
      min-width: 220px;
    }
    .strengths h4, .limitations h4 {
      margin: 0 0 .2rem;
      font-size: .7em;
    }
    .strengths ul, .limitations ul {
      margin: 0;
      padding-left: 1.1rem;
    }
    .strengths li, .limitations li {
      margin-bottom: .15rem;
    }
    .highlight {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: .4rem;
      padding: .1rem .4rem;
      box-shadow: 0 1px 3px rgba(251, 191, 36, 0.3);
      font-weight: 600;
    }
    #in-depth-summary {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      border: none !important;
      border-radius: 1rem !important;
      padding: 1.2rem 1.4rem !important;
      margin-bottom: 1rem !important;
      font-size: .55rem !important;
      line-height: 1.6 !important;
      white-space: pre-line !important;
      box-shadow: var(--shadow-lg) !important;
    }
    #summary-disclaimer {
      font-size: .42em;
      color: #64748b;
      margin-top: .6rem;
      padding: .8rem;
      background: #f8fafc;
      border-radius: .75rem;
      border-left: 4px solid var(--accent);
      line-height: 1.6;
    }
    @media (max-width: 950px) {
      main { grid-template-columns: 1fr; }
      .result-card { flex-direction: column; }
      .result-image { width: 100%; }
      .top-actions { position: static; justify-content: center; margin-top: .4rem; }
      header { padding-top: 2.2rem; }
    }
    @media print {
      /* Reset to clean print layout */
      * {
        box-shadow: none !important;
        transition: none !important;
        animation: none !important;
      }

      /* Hide interactive elements */
      header .top-actions,
      aside,
      .read-aloud-btn,
      .summary-actions {
        display: none !important;
      }

      body {
        background: #fff !important;
        font-family: "Georgia", "Times New Roman", serif;
        color: #1a202c;
        font-size: 11pt !important;
      }

      body, body * {
        font-size: inherit !important;
      }

      /* Header styling for print */
      header {
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%) !important;
        padding: 20mm 0 8mm !important;
        margin: -12mm -12mm 8mm !important;
        width: calc(100% + 24mm);
        box-shadow: none !important;
        page-break-after: avoid;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      header h1 {
        font-size: 24pt !important;
        margin-bottom: 3mm !important;
        letter-spacing: 0.5pt;
      }

      header small {
        font-size: 10pt !important;
        opacity: 0.95;
      }

      main {
        grid-template-columns: 1fr !important;
        display: block !important;
      }

      #right {
        padding: 0 !important;
        max-width: 100% !important;
      }

      /* Page 1: Options comparison */
      #results {
        page-break-after: always;
      }

      .result-card {
        background: #fff !important;
        border: 1.5pt solid #cbd5e1 !important;
        border-radius: 4mm !important;
        padding: 5mm 6mm !important;
        margin-bottom: 5mm !important;
        page-break-inside: avoid;
        break-inside: avoid;
        display: flex;
        gap: 5mm;
      }

      .result-card::before {
        display: none !important;
      }

      /* First option gets accent border */
      .result-card:first-child {
        border: 2pt solid #667eea !important;
        background: linear-gradient(to bottom, #f7fafc 0%, #ffffff 100%) !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .result-image {
        width: 50mm !important;
        flex: 0 0 50mm !important;
        background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%) !important;
        border-radius: 3mm !important;
        padding: 3mm !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .result-image img {
        box-shadow: 0 1mm 3mm rgba(0, 0, 0, 0.1) !important;
        border-radius: 2mm !important;
      }

      .result-image-label {
        font-size: 8pt !important;
        margin-top: 2mm;
      }

      .result-image-boiler {
        font-size: 9pt !important;
        font-weight: 700 !important;
      }

      .result-image-water {
        font-size: 8pt !important;
      }

      .result-body {
        flex: 1;
      }

      .result-header {
        margin-bottom: 3mm !important;
        border-bottom: 1pt solid #e2e8f0;
        padding-bottom: 2mm;
      }

      .result-title {
        font-size: 14pt !important;
        font-weight: 700 !important;
        font-family: "Georgia", serif;
        color: #2d3748;
      }

      .tick {
        width: 5mm !important;
        height: 5mm !important;
        font-size: 10pt !important;
        background: #e2e8f0 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .tick.active {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important;
        color: #fff !important;
        font-weight: 700 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .why {
        font-size: 10pt !important;
        margin-bottom: 3mm !important;
        font-style: italic;
        color: #4a5568;
        line-height: 1.5;
      }

      .list-cols {
        display: flex;
        gap: 8mm;
        margin-top: 3mm;
      }

      .strengths, .limitations {
        flex: 1;
        font-size: 9.5pt !important;
      }

      .strengths h4, .limitations h4 {
        font-size: 11pt !important;
        margin: 0 0 2mm !important;
        font-weight: 700 !important;
        color: #2d3748;
        border-bottom: 1pt solid #cbd5e1;
        padding-bottom: 1mm;
      }

      .strengths ul, .limitations ul {
        margin: 2mm 0 0 5mm !important;
        padding: 0 !important;
        line-height: 1.6;
      }

      .strengths li, .limitations li {
        margin-bottom: 2mm !important;
      }

      .highlight {
        background: #fef3c7 !important;
        padding: 0.5mm 1.5mm !important;
        border-radius: 1mm !important;
        font-weight: 600 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .result-content > div:last-child {
        font-size: 8pt !important;
        color: #64748b !important;
        margin-top: 3mm !important;
        padding-top: 2mm !important;
        border-top: 0.5pt dashed #cbd5e1;
        line-height: 1.5;
      }

      /* Page 2: Detailed summary */
      #in-depth-summary {
        background: #fff !important;
        border: none !important;
        padding: 0 !important;
        margin: 0 0 6mm !important;
        font-size: 10.5pt !important;
        line-height: 1.65 !important;
        white-space: pre-line !important;
        page-break-before: always;
        page-break-inside: auto;
        font-family: "Georgia", "Times New Roman", serif;
      }

      /* Add a nice header to page 2 */
      #in-depth-summary::before {
        content: "Detailed Analysis";
        display: block;
        font-size: 18pt !important;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 4mm;
        padding-bottom: 3mm;
        border-bottom: 2pt solid #667eea;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      #summary-disclaimer {
        font-size: 8.5pt !important;
        color: #4a5568 !important;
        background: #f7fafc !important;
        border-left: 3pt solid #667eea !important;
        padding: 4mm 5mm !important;
        margin-top: 5mm !important;
        border-radius: 2mm !important;
        line-height: 1.6 !important;
        page-break-inside: avoid;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      #summary-disclaimer::before {
        content: "Important Notice";
        display: block;
        font-weight: 700;
        font-size: 9.5pt !important;
        margin-bottom: 2mm;
        color: #2d3748;
      }

      @page {
        size: A4 portrait;
        margin: 12mm 15mm;
      }

      @page :first {
        margin-top: 0;
      }

      /* Add page numbers */
      @page {
        @bottom-right {
          content: "Page " counter(page) " of 2";
          font-size: 8pt;
          color: #64748b;
        }
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="top-actions">
      <button class="btn secondary" id="btn-export-data">Data CSV</button>
      <button class="btn secondary" id="btn-export-sources">Sources CSV</button>
      <button class="btn" id="btn-print">Print / PDF</button>
    </div>
    <h1>Which system is best for you?</h1>
    <small>UK, evidence-based, illustrative only.</small>
  </header>
  <main>
    <aside>
      <div class="nav-title">About you</div>
      <div class="panel">
        <label>
          House type
          <select id="houseType">
            <option value="flat/bungalow">Flat / Bungalow</option>
            <option value="terraced">Terraced</option>
            <option value="semi" selected>Semi-detached</option>
            <option value="detached">Detached</option>
          </select>
        </label>
        <label>
          Bedrooms
          <select id="bedrooms">
            <option>1</option>
            <option>2</option>
            <option selected>3</option>
            <option>4</option>
            <option>5</option>
          </select>
        </label>
        <label>
          Bathrooms
          <select id="bathrooms">
            <option>1</option>
            <option selected>2</option>
            <option>3</option>
          </select>
        </label>
        <label>
          People in home
          <select id="occupants">
            <option>1</option>
            <option>2</option>
            <option selected>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
          </select>
        </label>
        <label>
          Hot draws per day
          <input type="number" id="drawsPerDay" value="22" min="5" max="60" />
          <small style="color:#94a3b8;">Auto-adjusts with people, can override.</small>
        </label>
      </div>

      <div class="nav-title">Current system</div>
      <div class="panel">
        <label>
          Boiler type
          <select id="currentBoiler">
            <option value="regular" selected>Regular</option>
            <option value="system">System</option>
            <option value="combi">Combi</option>
          </select>
        </label>
        <label>
          Water
          <select id="currentWater">
            <option value="open_vented" selected>Open vented</option>
            <option value="mixergy_open">Mixergy open vented</option>
            <option value="unvented">Unvented</option>
            <option value="mixergy_unvented">Mixergy unvented</option>
            <option value="thermal_store">Thermal store</option>
            <option value="on_demand">On demand</option>
          </select>
        </label>
      </div>

      <div class="nav-title">Potential solution A</div>
      <div class="panel">
        <label>
          Boiler
          <select id="newABoiler">
            <option value="regular">Regular</option>
            <option value="system">System</option>
            <option value="combi" selected>Combi</option>
          </select>
        </label>
        <label>
          Water
          <select id="newAWater">
            <option value="open_vented">Open vented</option>
            <option value="mixergy_open">Mixergy open vented</option>
            <option value="unvented">Unvented</option>
            <option value="mixergy_unvented">Mixergy unvented</option>
            <option value="on_demand">On demand</option>
          </select>
        </label>
      </div>

      <div class="nav-title">Potential solution B</div>
      <div class="panel">
        <label>
          Boiler
          <select id="newBBoiler">
            <option value="regular">Regular</option>
            <option value="system">System</option>
            <option value="combi">Combi</option>
          </select>
        </label>
        <label>
          Water
          <select id="newBWater">
            <option value="open_vented">Open vented</option>
            <option value="mixergy_open">Mixergy open vented</option>
            <option value="unvented">Unvented</option>
            <option value="mixergy_unvented">Mixergy unvented</option>
            <option value="on_demand">On demand</option>
          </select>
        </label>
      </div>
    </aside>

    <div id="right">
      <!-- results will be injected here -->
      <div id="results"></div>
      <div class="summary-actions">
        <button type="button" class="read-aloud-btn" data-read-target="in-depth-summary" data-read-prefix="Overall summary">
          üîä Read summary
        </button>
      </div>
      <div id="in-depth-summary"></div>
      <div id="summary-disclaimer">
        This illustration is for guidance only and does not constitute financial advice, a quotation, or a heating system design.
        Figures are derived from UK field research (2015‚Äì2025) on domestic water use, DHW efficiency, combi lag, cylinder losses, and installer-reported performance.
        Values are indicative and should be confirmed by an on-site survey.
      </div>
    </div>
  </main>

  <script>
    // data (same as before, trimmed for brevity)
    const boilerLabels = {
      regular: "Regular",
      system: "System",
      combi: "Combi"
    };

    const boilerImages = {
      regular: "Data/Open-vented-schematic.jpeg",
      system: "Data/System-boiler.png",
      combi: "Data/Combination.png"
    };

    const waterLabels = {
      open_vented: "Open vented",
      mixergy_open: "Mixergy open vented",
      unvented: "Unvented",
      mixergy_unvented: "Mixergy unvented",
      thermal_store: "Thermal store",
      on_demand: "On demand"
    };

    const systemData = {
      combi: {
        baseWaste: {
          "flat/bungalow": 1,
          "terraced": 5.5,
          "semi": 5.5,
          "detached": 8
        },
        baseWait: {
          "flat/bungalow": 20,
          "terraced": 45,
          "semi": 45,
          "detached": 90
        },
        startupKWh: 0.025,
        postPurgeKWh: 0.015
      },
      stored: {
        wastePerDraw: 1.5,
        wait: 10,
        cylLoss: 1.5
      }
    };

    const sourcesList = [
      "Energy Saving Trust / BEIS domestic HW studies (2016‚Äì2023)",
      "SAP / BRE space & water efficiency assumptions",
      "Waterwise / OFWAT UK household water use",
      "Installer field data on combi lag and post-purge",
      "UK open-vented vs sealed system practice"
    ];

    function isOpenVentedWater(w) {
      return w === "open_vented" || w === "mixergy_open";
    }
    function isSealedWater(w) {
      return w === "unvented" || w === "mixergy_unvented";
    }
    function isCombiBoiler(b) {
      return b === "combi";
    }

    // science-based profiles
    const systemProfiles = {
      combi_on_demand: {
        label: "Combi Boiler",
        efficiency: "83‚Äì86%",
        installCost: "Relative install cost: Low (baseline for like-for-like swaps)",
        space: "No cylinder",
        lifespan: "10‚Äì12 years",
        maintenance: 4,
        hotWater: "Instantaneous, but one outlet ~6‚Äì10 L/min typical",
        pressure: "Needs good mains (>1.5 bar, >14 L/min)",
        renewables: "Poor ‚Äì no store for solar / HP",
        strengths: [
          "Compact, no tanks or cylinder",
          "Low standing losses",
          "Good for flats/small 1-bath with strong mains"
        ],
        limitations: [
          "Designed for one tap/shower at a time",
          "High water waste and cycling losses vs stored",
          "Shorter life vs stored systems",
          "Needs bigger gas than a 15 kW regular"
        ],
        bestFor: "Flats, small 1-bath homes with strong mains"
      },
      system_unvented: {
        label: "System Boiler (Unvented)",
        efficiency: "88‚Äì91%",
        installCost: "Relative install cost: Medium-high (cylinder + safety kit)",
        space: "Needs cylinder / airing cupboard",
        lifespan: "15‚Äì20 years",
        maintenance: 3,
        hotWater: "Stored, mains pressure, good multi-outlet",
        pressure: "Needs good mains pressure",
        renewables: "Excellent ‚Äì PV, Mixergy, heat pumps",
        strengths: [
          "High performance, balanced pressure",
          "Supports multiple outlets/bathrooms",
          "Future-proof: solar / PV / HP ready",
          "Holds real-world efficiency near ‚âà94%"
        ],
        limitations: [
          "Higher install cost",
          "Needs space for cylinder and discharge",
          "G3 service/annual maintenance"
        ],
        bestFor: "Modern 2‚Äì4 bed homes with 1‚Äì2 baths"
      },
      system_open: {
        label: "System Boiler (Open-Vented)",
        efficiency: "87‚Äì90%",
        installCost: "Relative install cost: Medium (system boiler + keep vented tanks)",
        space: "Vented cylinder + loft tank",
        lifespan: "15‚Äì20 years",
        maintenance: 3,
        hotWater: "Stored, gravity or pumped (low pressure)",
        pressure: "Works with poor mains when boosted",
        renewables: "Good with solar coil / vented Mixergy",
        strengths: [
          "Modern boiler internals while keeping vented pipework",
          "External pumps and controls allow easy zoning",
          "Tolerant of legacy systems and solid-fuel links"
        ],
        limitations: [
          "Still relies on loft tanks unless upgraded",
          "Lower pressure comfort without pumps",
          "Lower efficiency in practice vs sealed unvented"
        ],
        bestFor: "Homes keeping vented hot water but wanting a system boiler plant"
      },
      regular_open: {
        label: "Regular Boiler (Open-Vented)",
        efficiency: "86‚Äì89%",
        installCost: "Relative install cost: Low-medium (staying vented keeps costs down)",
        space: "Loft tank + airing cupboard",
        lifespan: "15‚Äì25 years",
        maintenance: 2,
        hotWater: "Stored, gravity or pumped (low pressure)",
        pressure: "Works with poor mains",
        renewables: "Good with solar coil / vented Mixergy",
        strengths: [
          "Simple, tolerant, long life",
          "Good for poor mains / rural",
          "Low maintenance"
        ],
        limitations: [
          "Low pressure unless pumped",
          "Tanks in loft",
          "Less efficient than unvented in practice"
        ],
        bestFor: "Older houses, rural or low-pressure areas"
      },
      mixergy_open: {
        label: "Mixergy ‚Äì Open-Vented (Smart Cylinder + Regular)",
        efficiency: "87‚Äì90%",
        installCost: "Relative install cost: Medium-high (smart cylinder premium)",
        space: "Vented cylinder + loft tank",
        lifespan: "20‚Äì25 years",
        maintenance: 3,
        hotWater: "Stored, stratified, gravity or pumped",
        pressure: "Works with poor mains",
        renewables: "Excellent ‚Äì PV / boiler / HP compatible",
        strengths: [
          "Smart control, partial heat saves energy",
          "Stays vented ‚Üí gentle on old pipework",
          "PV and future HP friendly"
        ],
        limitations: [
          "Still vented ‚Äì needs loft tank & pump for power showers",
          "Higher capital than plain vented",
          "Needs space"
        ],
        bestFor: "Upgraded vented systems, low-pressure areas wanting smart control"
      },
      system_mixergy_open: {
        label: "Mixergy ‚Äì Open-Vented (Smart Cylinder + System)",
        efficiency: "88‚Äì91%",
        installCost: "Relative install cost: Medium-high (smart cylinder premium)",
        space: "Vented cylinder + loft tank",
        lifespan: "20‚Äì25 years",
        maintenance: 3,
        hotWater: "Stored, smart stratified, gravity or pumped",
        pressure: "Works with poor mains",
        renewables: "Excellent ‚Äì PV / boiler / HP compatible",
        strengths: [
          "Smart control reduces reheat with system boilers",
          "Gentle on existing vented pipework",
          "Easy future upgrade path to renewables"
        ],
        limitations: [
          "Loft tanks remain in place",
          "Premium kit cost vs plain cylinder",
          "Needs space for cylinder and F&E tank"
        ],
        bestFor: "Vented homes wanting smart cylinder control with a system boiler"
      },
      regular_unvented: {
        label: "Regular Boiler (Unvented)",
        efficiency: "87‚Äì90%",
        installCost: "Relative install cost: Medium-high (conversion to sealed + safety kit)",
        space: "Unvented cylinder",
        lifespan: "15‚Äì20 years",
        maintenance: 3,
        hotWater: "Stored, mains pressure, multi-outlet",
        pressure: "Needs good mains pressure",
        renewables: "Good ‚Äì works with solar coils and diverters",
        strengths: [
          "Keeps familiar regular boiler layout",
          "Delivers mains-pressure hot water across outlets",
          "Compatible with solar thermal and PV dump controls"
        ],
        limitations: [
          "Conversion work and discharge pipework add cost",
          "Requires G3 maintenance and safety checks",
          "Sealing old pipework needs careful system prep"
        ],
        bestFor: "Upgrading vented regular systems where mains can support sealed hot water"
      },
      mixergy_unvented: {
        label: "Mixergy ‚Äì Unvented (Smart Cylinder + System)",
        efficiency: "89‚Äì92%",
        installCost: "Relative install cost: High (premium smart unvented setup)",
        space: "Unvented cylinder",
        lifespan: "20‚Äì25 years",
        maintenance: 3,
        hotWater: "Stored, mains pressure, multi-outlet",
        pressure: "Needs strong mains",
        renewables: "Excellent ‚Äì PV, HP, dynamic tariffs",
        strengths: [
          "High performance, future-proof",
          "Smart energy savings",
          "Mains pressure hot water"
        ],
        limitations: [
          "High capital cost",
          "G3 requirements",
          "Needs good mains pressure"
        ],
        bestFor: "Modern medium-large homes, multi-bath setups"
      },
      regular_mixergy_unvented: {
        label: "Mixergy ‚Äì Unvented (Smart Cylinder + Regular)",
        efficiency: "88‚Äì91%",
        installCost: "Relative install cost: High (smart unvented + system conversion)",
        space: "Unvented smart cylinder",
        lifespan: "20‚Äì25 years",
        maintenance: 3,
        hotWater: "Stored, mains pressure, smart stratification",
        pressure: "Needs good mains pressure",
        renewables: "Excellent ‚Äì PV, heat pump, dynamic tariffs",
        strengths: [
          "Retains regular boiler hardware with mains-pressure hot water",
          "Smart control cuts reheat losses and works with PV",
          "Future-ready for hybrid heat sources"
        ],
        limitations: [
          "Requires sealed conversion and G3 servicing",
          "High capital cost vs plain vented regular",
          "Needs strong incoming mains pressure"
        ],
        bestFor: "Households wanting to keep a regular boiler but gain smart unvented performance"
      },
      thermal_store: {
        label: "Thermal Store Cylinder",
        efficiency: "85‚Äì90%",
        installCost: "Relative install cost: Medium-high (store + controls)",
        space: "Thermal store / airing cupboard",
        lifespan: "15‚Äì20 years",
        maintenance: 3,
        hotWater: "Stored, instantaneous via plate, mains pressure",
        pressure: "Needs good mains and careful design",
        renewables: "Excellent ‚Äì supports multiple heat sources",
        strengths: [
          "Integrates boilers, solar, stoves and heat pumps",
          "Mains-pressure hot water without G3 discharge",
          "Enables load shifting with PV diverters"
        ],
        limitations: [
          "Higher standing losses than simple cylinders",
          "Complex controls need specialist commissioning",
          "Requires space and good insulation"
        ],
        bestFor: "Homes linking multiple heat sources or wanting thermal buffering"
      }
    };

    const profileKeyByCombo = {
      "combi|on_demand": "combi_on_demand",
      "regular|open_vented": "regular_open",
      "regular|mixergy_open": "mixergy_open",
      "regular|unvented": "regular_unvented",
      "regular|mixergy_unvented": "regular_mixergy_unvented",
      "regular|thermal_store": "thermal_store",
      "system|open_vented": "system_open",
      "system|mixergy_open": "system_mixergy_open",
      "system|unvented": "system_unvented",
      "system|mixergy_unvented": "mixergy_unvented",
      "system|thermal_store": "thermal_store"
    };

    // map boiler+water ‚Üí profile key
    function pickSystemProfile(boiler, water) {
      const key = `${boiler}|${water}`;
      if (profileKeyByCombo[key]) return profileKeyByCombo[key];

      if (water === "thermal_store") return "thermal_store";
      if (water === "mixergy_unvented") return "mixergy_unvented";
      if (water === "unvented") return boiler === "regular" ? "regular_unvented" : "system_unvented";
      if (water === "mixergy_open") return boiler === "system" ? "system_mixergy_open" : "mixergy_open";
      if (water === "open_vented") return boiler === "system" ? "system_open" : "regular_open";
      if (water === "on_demand") return "combi_on_demand";

      if (boiler === "combi") return "combi_on_demand";
      if (boiler === "system") return "system_unvented";
      if (boiler === "regular") return "regular_open";
      return "combi_on_demand";
    }

    function renderInDepthSummary(options, ctx) {
      const box = document.getElementById("in-depth-summary");
      if (!box) return;

      const best = options[0];
      const second = options[1];

      if (!best) {
        box.textContent = "";
        return;
      }

      const bestProfile = systemProfiles[pickSystemProfile(best.boiler, best.water)];
      const secondProfile = second ? systemProfiles[pickSystemProfile(second.boiler, second.water)] : null;

      const comingFromOpen = ctx.currentWater === "open_vented" || ctx.currentWater === "mixergy_open";

      const parts = [];

      parts.push("Explanation of the two options");
      parts.push("");

      // BEST
      if (bestProfile) {
        parts.push(`1) ${bestProfile.label}`);
        parts.push(`‚Ä¢ What it is: ${bestProfile.hotWater}.`);
        parts.push(`‚Ä¢ Efficiency (real): ${bestProfile.efficiency}; install typically ${bestProfile.installCost}.`);
        parts.push("‚Ä¢ Strengths:");
        bestProfile.strengths.forEach(s => parts.push("   - " + s));
        parts.push("‚Ä¢ Limitations:");
        bestProfile.limitations.forEach(l => parts.push("   - " + l));
        if (comingFromOpen && (best.boiler === "combi" || best.boiler === "system" || best.water === "unvented" || best.water === "mixergy_unvented")) {
          parts.push("   - Converting from open-vented to sealed/high pressure can expose minor existing leaks/weeps.");
        }
        parts.push("");
      }

      // SECOND
      if (second && secondProfile) {
        parts.push(`2) ${secondProfile.label}`);
        parts.push(`‚Ä¢ What it is: ${secondProfile.hotWater}.`);
        parts.push(`‚Ä¢ Efficiency (real): ${secondProfile.efficiency}; install typically ${secondProfile.installCost}.`);
        parts.push("‚Ä¢ Strengths:");
        secondProfile.strengths.forEach(s => parts.push("   - " + s));
        parts.push("‚Ä¢ Limitations:");
        secondProfile.limitations.forEach(l => parts.push("   - " + l));
        if (comingFromOpen && (second.boiler === "combi" || second.boiler === "system" || second.water === "unvented" || second.water === "mixergy_unvented")) {
          parts.push("   - As above, pressurising can highlight existing weeps.");
        }
        parts.push("");
      }

      parts.push("Disclaimer: This comparison is illustrative and based on typical UK domestic installs (2015‚Äì2025). Actual pressure, G3/unvented requirements, and costs must be confirmed on site.");

      box.textContent = parts.join("\n");
    }

    function getRecommendedDraws(people) {
      const p = Number(people);
      if (p <= 1) return 12;
      if (p === 2) return 18;
      if (p === 3) return 22;
      if (p === 4) return 26;
      if (p === 5) return 30;
      return 34;
    }

    function evaluateOption({houseType, occupants, bathrooms, drawsPerDay, currentBoiler, currentWater, newBoiler, newWater}) {
      const isCombi = newBoiler === "combi";
      const isStored = newWater === "unvented" || newWater === "mixergy_unvented" || newWater === "open_vented" || newWater === "mixergy_open" || newWater === "on_demand";
      const isCurrentStored = currentWater !== "on_demand" && currentWater !== "unvented" ? true : (currentWater !== "on_demand");
      const isCurrentOpen = currentWater === "open_vented" || currentWater === "mixergy_open";

      let score = 0;
      let dailyWasteL = 0;
      let dailyOverheadKWh = 0;
      let dailyCylinderLoss = 0;
      const pros = [];
      const cons = [];
      const relevant = new Set();

      // performance
      if (isCombi) {
        const wastePerDraw = systemData.combi.baseWaste[houseType] ?? 5.5;
        const wait = systemData.combi.baseWait[houseType] ?? 45;
        dailyWasteL = wastePerDraw * drawsPerDay;
        dailyOverheadKWh = (systemData.combi.startupKWh + systemData.combi.postPurgeKWh) * drawsPerDay;
        pros.push("Single appliance, frees space");
        cons.push(`Hot water lag ${wait}s to tap`);
        cons.push(`Wastes about ${wastePerDraw.toFixed(1)} L per draw (${dailyWasteL.toFixed(1)} L/day)`);
        cons.push(`Per-draw energy overhead ‚âà ${dailyOverheadKWh.toFixed(2)} kWh/day`);
        // suitability
        if (occupants <= 3 && bathrooms <= 2) {
          score += 3;
          relevant.add("pros:Single appliance, frees space");
        } else {
          score -= 2;
          relevant.add(`cons:Hot water lag ${wait}s to tap`);
        }
      } else {
        // stored / cylinder
        dailyWasteL = systemData.stored.wastePerDraw * drawsPerDay;
        dailyCylinderLoss = systemData.stored.cylLoss;
        pros.push("Shorter tap-to-hot, better comfort");
        pros.push("Longer boiler burns ‚Üí better modulation");
        cons.push(`Cylinder standing loss ‚âà ${dailyCylinderLoss.toFixed(1)} kWh/day`);
        score += 3;
        if (occupants >= 4 || bathrooms >= 2) {
          pros.push("Better for multiple/simultaneous draws");
          score += 2;
          relevant.add("pros:Better for multiple/simultaneous draws");
        }
      }

      // cost / disruption
      // 1) open vented ‚Üí unvented
      if (isCurrentOpen && (newWater === "unvented" || newWater === "mixergy_unvented")) {
        cons.push("Open-vented ‚Üí unvented typically adds a notable premium for upgrade work");
        score -= 1;
        relevant.add("cons:Open-vented ‚Üí unvented typically adds a notable premium for upgrade work");
      }
      // 2) stored ‚Üí combi (common UK reality: noticeable extra labour/material)
      if (newBoiler === "combi" && currentBoiler !== "combi") {
        cons.push("Converting to a combi from stored often adds a noticeable premium for pipework and cylinder removal");
        score -= 1;
        relevant.add("cons:Converting to a combi from stored often adds a noticeable premium for pipework and cylinder removal");
      }
      // 3) like-for-like
      if (newBoiler === currentBoiler && newWater === currentWater) {
        pros.push("Like-for-like keeps cost and disruption low");
        score += 2;
        relevant.add("pros:Like-for-like keeps cost and disruption low");
      }

      return {
        score,
        dailyWasteL,
        dailyOverheadKWh,
        dailyCylinderLoss,
        pros,
        cons,
        relevant
      };
    }

    async function render() {
      const houseType = document.getElementById("houseType").value;
      const bedrooms = document.getElementById("bedrooms").value;
      const bathrooms = parseInt(document.getElementById("bathrooms").value, 10);
      const occupants = parseInt(document.getElementById("occupants").value, 10);
      const drawsPerDay = parseInt(document.getElementById("drawsPerDay").value, 10);
      const currentBoiler = document.getElementById("currentBoiler").value;
      const currentWater = document.getElementById("currentWater").value;
      const newABoiler = document.getElementById("newABoiler").value;
      const newAWater = document.getElementById("newAWater").value;
      const newBBoiler = document.getElementById("newBBoiler").value;
      const newBWater = document.getElementById("newBWater").value;

      const evalA = evaluateOption({houseType, occupants, bathrooms, drawsPerDay, currentBoiler, currentWater, newBoiler:newABoiler, newWater:newAWater});
      const evalB = evaluateOption({houseType, occupants, bathrooms, drawsPerDay, currentBoiler, currentWater, newBoiler:newBBoiler, newWater:newBWater});

      // pick best
      const options = [
        {
          id: "A",
          title: `Option A: ${formatBoilerName(newABoiler)} + ${formatWaterName(newAWater)}`,
          boiler: newABoiler,
          boilerLabel: formatBoilerName(newABoiler),
          water: newAWater,
          waterLabel: formatWaterName(newAWater),
          ...evalA
        },
        {
          id: "B",
          title: `Option B: ${formatBoilerName(newBBoiler)} + ${formatWaterName(newBWater)}`,
          boiler: newBBoiler,
          boilerLabel: formatBoilerName(newBBoiler),
          water: newBWater,
          waterLabel: formatWaterName(newBWater),
          ...evalB
        }
      ].sort((a,b) => b.score - a.score); // best first

      const bestId = options[0].id;

      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = options.map(opt => {
        const why = makeWhyText(opt, occupants, bathrooms);
        return makeResultCard(opt, why, opt.id === bestId);
      }).join("");

      // in-depth summary based on both options and the current system
      renderInDepthSummary(options, {
        currentWater,
        currentBoiler,
        bathrooms,
        occupants
      });
    }

    function makeWhyText(opt, occupants, bathrooms) {
      // short explanation
      if (opt.boiler === "combi") {
        if (occupants <= 3 && bathrooms <= 2) {
          return "Works for your size household, but expect some hot-water lag and per-draw energy overhead.";
        }
        return "Will work, but your usage suggests stored water would reduce lag and wasted water.";
      } else {
        return "Stored hot water suits your household because it reduces wait time and copes better with multiple uses.";
      }
    }

    function escapeAttr(value) {
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function makeResultCard(opt, why, isBest) {
      // get profile
      const profileKey = pickSystemProfile(opt.boiler, opt.water);
      const profile = systemProfiles[profileKey] || systemProfiles.combi_on_demand;

      // relevance logic
      const currentWater = document.getElementById("currentWater").value;
      const comingFromOpen = currentWater === "open_vented" || currentWater === "mixergy_open";
      const targetIsSealed =
        opt.boiler === "combi" ||
        opt.boiler === "system" ||
        opt.water === "unvented" ||
        opt.water === "mixergy_unvented";

      // build pros/cons from profile
      const prosHtml = (profile.strengths || []).map(p => {
        let highlight = false;
        // highlight future-proof if system/mixergy
        if (p.toLowerCase().includes("future") || p.toLowerCase().includes("pv")) {
          highlight = true;
        }
        // highlight ‚Äúworks with poor mains‚Äù if current is open vented
        if (comingFromOpen && p.toLowerCase().includes("poor mains")) {
          highlight = true;
        }
        return `<li${highlight ? ' class="highlight"' : ''}>${p}</li>`;
      }).join("");

      const consArray = profile.limitations ? [...profile.limitations] : [];

      // add dynamic cons
      if (comingFromOpen && targetIsSealed) {
        consArray.push("Converting from open vented to sealed/high pressure can expose minor existing leaks/weeps.");
      }
      if (opt.boiler === "combi") {
        consArray.push("Designed for one tap/shower at a time; performance follows mains.");
        consArray.push("Combi will usually need a bigger gas supply than a 15 kW regular.");
      }

      const consHtml = consArray.map(c => {
        let highlight = false;
        if (c.toLowerCase().includes("leak") || c.toLowerCase().includes("sealed")) {
          highlight = true;
        }
        if (c.toLowerCase().includes("mains") && currentWater === "open_vented") {
          highlight = true;
        }
        return `<li${highlight ? ' class="highlight"' : ''}>${c}</li>`;
      }).join("");

      const textId = `option-text-${opt.id}`;
      const readPrefix = escapeAttr(opt.title);

      return `
      <div class="result-card">
        <div class="result-image">
          ${renderBoilerImage(opt)}
          <div class="result-image-label">
            <span class="result-image-boiler">${profile.label}</span>
            <span class="result-image-water">${formatWaterName(opt.water)}</span>
          </div>
        </div>
        <div class="result-body">
          <div class="result-header">
            <div class="tick ${isBest ? 'active' : ''}">${isBest ? '‚úì' : ''}</div>
            <div class="result-title">${opt.title}</div>
            <button type="button" class="read-aloud-btn" data-read-target="${textId}" data-read-prefix="${readPrefix}">
              üîä Read aloud
            </button>
          </div>
          <div class="result-content" id="${textId}">
            <div class="why">${why}</div>
            <div class="list-cols">
              <div class="strengths">
                <h4>Strengths</h4>
                <ul>
                  ${prosHtml || "<li>No key strengths recorded.</li>"}
                </ul>
              </div>
              <div class="limitations">
                <h4>Limitations</h4>
                <ul>
                  ${consHtml || "<li>No key limitations recorded.</li>"}
                </ul>
              </div>
            </div>
            <div style="font-size:.4em;color:#475569;margin-top:.35rem;">
              Seasonal/real-world efficiency: ${profile.efficiency} ¬∑ Install cost: ${profile.installCost} ¬∑ Space: ${profile.space} ¬∑ Lifespan: ${profile.lifespan} ¬∑ Best suited: ${profile.bestFor}
            </div>
          </div>
        </div>
      </div>
      `;
    }

    function renderBoilerImage(opt) {
      const src = boilerImages[opt.boiler];
      if (!src) {
        return "";
      }
      const alt = `${opt.boilerLabel} boiler illustration`;
      return `<img src="${src}" alt="${alt}" />`;
    }

    function formatBoilerName(value) {
      return boilerLabels[value] || value;
    }

    function formatWaterName(value) {
      return waterLabels[value] || value.replace(/_/g, " ");
    }

    // events
    document.querySelectorAll("select,input").forEach(el => el.addEventListener("input", render));
    document.getElementById("occupants").addEventListener("input", e => {
      const rec = getRecommendedDraws(e.target.value);
      const draws = document.getElementById("drawsPerDay");
      draws.value = rec;
      render();
    });
    document.getElementById("btn-print").addEventListener("click", () => window.print());
    document.getElementById("btn-export-data").addEventListener("click", () => {
      alert("In this cut-down version, CSV export is stubbed. Use previous version's CSV section to keep data + sources.");
    });
    document.getElementById("btn-export-sources").addEventListener("click", () => {
      alert("Sources used:\n- " + sourcesList.join("\n- "));
    });

    function enforceCombiWater(boilerId, waterId) {
      const boiler = document.getElementById(boilerId);
      const water = document.getElementById(waterId);
      if (!boiler || !water) return;

      const updateWater = () => {
        if (boiler.value === "combi" && water.value !== "on_demand") {
          water.value = "on_demand";
          return true;
        }
        return false;
      };

      boiler.addEventListener("change", () => {
        const changed = updateWater();
        if (changed) {
          render();
        }
      });

      water.addEventListener("change", () => {
        const changed = updateWater();
        if (changed) {
          render();
        }
      });

      updateWater();
    }

    enforceCombiWater("currentBoiler", "currentWater");
    enforceCombiWater("newABoiler", "newAWater");
    enforceCombiWater("newBBoiler", "newBWater");

    function speakElement(targetId, prefix = "") {
      if (!("speechSynthesis" in window)) {
        alert("Read aloud is not supported in this browser.");
        return;
      }
      const el = document.getElementById(targetId);
      if (!el) return;
      const text = el.innerText.trim();
      const fullText = [prefix.trim(), text].filter(Boolean).join(". ");
      if (!fullText) return;
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(fullText);
      window.speechSynthesis.speak(utterance);
    }

    document.addEventListener("click", event => {
      const btn = event.target.closest(".read-aloud-btn");
      if (!btn) return;
      event.preventDefault();
      const targetId = btn.getAttribute("data-read-target");
      if (!targetId) return;
      const prefix = btn.getAttribute("data-read-prefix") || "";
      speakElement(targetId, prefix);
    });

    render();
  </script>
</body>
</html>