<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Which system is best for you?</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f8fafc;
      --fg: #0f172a;
      --card: #ffffff;
      --accent: #0ea5e9;
      --muted: #64748b;
      --border: #e2e8f0;
      --good: #22c55e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: .75rem 1rem .5rem;
      text-align: center;
      background: #fff;
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
      color: #0f172a;
    }
    header small {
      display: block;
      margin-top: .25rem;
      color: var(--muted);
      font-size: .63rem;
    }
    .top-actions {
      position: absolute;
      right: 1rem;
      top: .55rem;
      display: flex;
      gap: .4rem;
    }
    .btn {
      background: var(--accent);
      border: none;
      color: #fff;
      padding: .35rem .6rem;
      border-radius: .5rem;
      font-size: .63rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn.secondary {
      background: #fff;
      border: 1px solid var(--border);
      color: #0f172a;
    }
    main {
      display: grid;
      grid-template-columns: 270px minmax(0, 1fr);
      flex: 1;
      min-height: 0;
    }
    aside {
      border-right: 1px solid var(--border);
      background: #f1f5f9;
      padding: .5rem .5rem 3rem;
      overflow-y: auto;
    }
    .nav-title {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .04em;
      margin: .5rem 0 .25rem;
      color: #475569;
    }
    .panel {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: .6rem;
      margin-bottom: .5rem;
      padding: .5rem .5rem .25rem;
    }
    .panel h2 {
      font-size: .7rem;
      margin: 0 0 .35rem;
      color: #1f2937;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: .2rem;
      font-size: .65rem;
      margin-bottom: .35rem;
    }
    select, input {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: .4rem;
      padding: .25rem .35rem;
      font-size: .65rem;
      color: #0f172a;
    }
    #right {
      display: grid;
      grid-template-rows: 250px minmax(260px, 1fr);
      min-height: 0;
    }
    #top-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: .5rem;
      padding: .5rem;
      min-height: 0;
    }
    .choice-box {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: .6rem;
      padding: .4rem .4rem .1rem;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .choice-head {
      display: flex;
      align-items: center;
      gap: .4rem;
      margin-bottom: .4rem;
    }
    .choice-head h3 {
      font-size: .73rem;
      margin: 0;
    }
    .tick {
      width: 1.1rem;
      height: 1.1rem;
      border-radius: 9999px;
      background: #e2e8f0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .7rem;
      flex: 0 0 auto;
    }
    .tick.active {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #22c55e;
    }
    .choice-body {
      flex: 1;
      overflow-y: auto;
      font-size: .65rem;
      line-height: 1.4;
    }
    #summary {
      padding: .5rem;
    }
    #summary-box {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: .6rem;
      padding: .6rem .6rem .35rem;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: .4rem;
    }
    /* picture boxes */
    .picture-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: .4rem;
    }
    .pic-box {
      border: 1px solid #dbeafe;
      border-radius: .5rem;
      min-height: 90px;
      background: #eff6ff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      font-size: .58rem;
      color: #475569;
      padding: .25rem;
    }
    .pic-label {
      display: inline-flex;
      flex-direction: column;
      gap: .2rem;
    }
    .pic-diagram {
      width: 100%;
      margin-top: .35rem;
      display: none;
    }
    .pic-diagram img,
    .pic-diagram svg {
      width: 100%;
      height: auto;
      max-height: 180px;
      object-fit: contain;
      border-radius: .4rem;
    }
    #summary-text {
      flex: 1;
      overflow-y: auto;
      font-size: .68rem;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    #summary-disclaimer {
      font-size: .58rem;
      color: #475569;
      margin-top: .15rem;
      border-top: 1px solid #e2e8f0;
      padding-top: .3rem;
    }
    @media (max-width: 950px) {
      main { grid-template-columns: 1fr; }
      #right { grid-template-rows: auto auto; }
      #top-row { grid-template-columns: 1fr; }
      .top-actions { position: static; justify-content: center; margin-top: .4rem; }
      header { padding-top: 2.2rem; }
    }
    @media print {
      header, aside, #top-row, .top-actions { display: none !important; }
      main { grid-template-columns: 1fr !important; }
      #summary { padding: 0; }
      #summary-box { border: none; }
      body { background: #fff; }
    }
  </style>
</head>
<body>
  <header>
    <div class="top-actions">
      <button class="btn secondary" id="btn-sources">Sources</button>
      <button class="btn secondary" id="btn-export-data">Data CSV</button>
      <button class="btn secondary" id="btn-export-sources">Sources CSV</button>
      <button class="btn" id="btn-print">Print / PDF</button>
    </div>
    <h1>Which system is best for you?</h1>
    <small>Compare two potential upgrades against your current UK setup.</small>
  </header>
  <main>
    <aside>
      <div class="nav-title">About you</div>
      <div class="panel">
        <label>
          House type
          <select id="houseType">
            <option value="flat/bungalow">Flat / Bungalow</option>
            <option value="terraced">Terraced</option>
            <option value="semi" selected>Semi-detached</option>
            <option value="detached">Detached</option>
          </select>
        </label>
        <label>
          Bedrooms
          <select id="bedrooms">
            <option>1</option>
            <option>2</option>
            <option selected>3</option>
            <option>4</option>
            <option>5</option>
          </select>
        </label>
        <label>
          Bathrooms
          <select id="bathrooms">
            <option>1</option>
            <option selected>2</option>
            <option>3</option>
          </select>
        </label>
        <label>
          People in home
          <select id="occupants">
            <option>1</option>
            <option>2</option>
            <option selected>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
          </select>
        </label>
        <label>
          Hot draws per day
          <input type="number" id="drawsPerDay" value="22" min="5" max="60" />
          <small style="color:#94a3b8;">Auto-adjusts with occupancy, but you can override.</small>
        </label>
      </div>

      <div class="nav-title">Current system</div>
      <div class="panel">
        <label>
          Boiler type
          <select id="currentBoiler">
            <option value="regular">Regular</option>
            <option value="system">System</option>
            <option value="combi" selected>Combi</option>
          </select>
        </label>
        <label>
          Water
          <select id="currentWater">
            <option value="open_vented">Open vented</option>
            <option value="mixergy_open">Mixergy open vented</option>
            <option value="unvented">Unvented</option>
            <option value="mixergy_unvented">Mixergy unvented</option>
            <option value="thermal_store">Thermal store</option>
            <option value="on_demand">On demand</option>
          </select>
        </label>
      </div>

      <div class="nav-title">Potential solution A</div>
      <div class="panel">
        <label>
          Boiler
          <select id="newABoiler">
            <option value="regular">Regular</option>
            <option value="system">System</option>
            <option value="combi" selected>Combi</option>
          </select>
        </label>
        <label>
          Water
          <select id="newAWater">
            <option value="open_vented">Open vented</option>
            <option value="mixergy_open">Mixergy open vented</option>
            <option value="unvented">Unvented</option>
            <option value="mixergy_unvented">Mixergy unvented</option>
            <option value="on_demand">On demand</option>
          </select>
        </label>
      </div>

      <div class="nav-title">Potential solution B</div>
      <div class="panel">
        <label>
          Boiler
          <select id="newBBoiler">
            <option value="regular">Regular</option>
            <option value="system">System</option>
            <option value="combi">Combi</option>
          </select>
        </label>
        <label>
          Water
          <select id="newBWater">
            <option value="open_vented">Open vented</option>
            <option value="mixergy_open">Mixergy open vented</option>
            <option value="unvented">Unvented</option>
            <option value="mixergy_unvented">Mixergy unvented</option>
            <option value="on_demand">On demand</option>
          </select>
        </label>
      </div>
    </aside>

    <div id="right">
      <div id="top-row">
        <div class="choice-box">
          <div class="choice-head">
            <div class="tick" id="bestTick"></div>
            <h3>Best choice</h3>
          </div>
          <div class="choice-body" id="bestBody">
            Fill in your details to see the best match.
          </div>
        </div>
        <div class="choice-box">
          <div class="choice-head">
            <div class="tick" id="secondTick"></div>
            <h3>Second choice</h3>
          </div>
          <div class="choice-body" id="secondBody">
            Second option will appear here.
          </div>
        </div>
      </div>
      <div id="summary">
        <div id="summary-box">
          <div class="picture-row" id="pictureRow">
            <div class="pic-box" id="picCurrent">
              <div class="pic-label">Current system<br><span id="picCurrentLabel"></span></div>
              <div class="pic-diagram" id="picCurrentDiagram" aria-hidden="true"></div>
            </div>
            <div class="pic-box" id="picA">
              <div class="pic-label">Option A<br><span id="picALabel"></span></div>
              <div class="pic-diagram" id="picADiagram" aria-hidden="true"></div>
            </div>
            <div class="pic-box" id="picB">
              <div class="pic-label">Option B<br><span id="picBLabel"></span></div>
              <div class="pic-diagram" id="picBDiagram" aria-hidden="true"></div>
            </div>
          </div>
          <div id="summary-text">
            Summary will appear here.
          </div>
          <div id="summary-disclaimer">
            This illustration is for guidance only and does not constitute financial advice, a quotation, or a heating system design.
            Figures are derived from independent UK research between 2015–2025, including field studies, manufacturer data, and government modelling.
            Key sources include:
            <ul style="margin:4px 0 0 14px; padding:0; font-size:0.58rem; line-height:1.4;">
              <li>Energy Saving Trust &amp; BEIS domestic hot water field trials (2016–2023)</li>
              <li>BRE and SAP 10.2 modelling data for system efficiencies</li>
              <li>Waterwise and OFWAT household water use reports</li>
              <li>Manufacturer and installer field measurements of combi lag, post-purge losses, and cylinder standing heat losses</li>
              <li>UK building services engineering best-practice data on open-vented and sealed systems</li>
            </ul>
            Values are representative of typical conditions and should be interpreted as indicative, not guaranteed.
            Always base system selection on a full on-site survey.
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ==========================
    // inline data
    // ==========================
    const systemPerformanceData = [
      {category:"occupancy",bedrooms:"1",metric:"household_total_water_use",value:149,units:"L/day",source_id:"S1"},
      {category:"occupancy",bedrooms:"2",metric:"household_total_water_use",value:276,units:"L/day",source_id:"S1"},
      {category:"occupancy",bedrooms:"3",metric:"household_total_water_use",value:450,units:"L/day",source_id:"S1"},
      {category:"occupancy",bedrooms:"4",metric:"household_total_water_use",value:500,units:"L/day",source_id:"S1"},
      {category:"occupancy",bedrooms:"5",metric:"household_total_water_use",value:550,units:"L/day",source_id:"S1"},
      {category:"hot_water",metric:"hot_water_use_per_dwelling",value:80,units:"L/day",source_id:"S2"},
      {category:"hot_water",metric:"hot_water_energy",value:4,units:"kWh/day",source_id:"S2"},
      {category:"distribution_waste",system_type:"combi",house_type:"flat/bungalow",metric:"hot_water_waste_per_draw",value:1,units:"L/draw",source_id:"S3"},
      {category:"distribution_waste",system_type:"combi",house_type:"terraced",metric:"hot_water_waste_per_draw",value:5.5,units:"L/draw",source_id:"S3"},
      {category:"distribution_waste",system_type:"combi",house_type:"semi",metric:"hot_water_waste_per_draw",value:5.5,units:"L/draw",source_id:"S3"},
      {category:"distribution_waste",system_type:"combi",house_type:"detached",metric:"hot_water_waste_per_draw",value:8,units:"L/draw",source_id:"S3"},
      {category:"distribution_waste",system_type:"combi",house_type:"terraced",metric:"hot_water_wait_time",value:45,units:"s",source_id:"S3"},
      {category:"distribution_waste",system_type:"combi",house_type:"semi",metric:"hot_water_wait_time",value:45,units:"s",source_id:"S3"},
      {category:"distribution_waste",system_type:"combi",house_type:"detached",metric:"hot_water_wait_time",value:90,units:"s",source_id:"S3"},
      {category:"distribution_waste",system_type:"regular/unvented",house_type:"all",metric:"hot_water_waste_per_draw",value:1.5,units:"L/draw",source_id:"S3"},
      {category:"distribution_waste",system_type:"regular/unvented",house_type:"all",metric:"hot_water_wait_time",value:10,units:"s",source_id:"S3"},
      {category:"combi_losses",metric:"dhw_startup_loss_per_draw",value:0.025,units:"kWh/draw",source_id:"S4"},
      {category:"combi_losses",metric:"post_purge_dump_per_draw",value:0.015,units:"kWh/draw",source_id:"S4"},
      {category:"combi_losses",house_type:"semi",metric:"dhw_distribution_and_control_losses",value:600,units:"kWh/year",source_id:"S4"},
      {category:"combi_losses",house_type:"detached",metric:"dhw_distribution_and_control_losses",value:750,units:"kWh/year",source_id:"S4"},
      {category:"system_efficiency",system_type:"open_vented",metric:"real_world_efficiency_penalty",value:2,units:"percent",source_id:"S5"},
      {category:"system_efficiency",system_type:"sealed",metric:"real_world_efficiency_penalty",value:0,units:"percent",source_id:"S5"},
      {category:"system_efficiency",system_type:"combi",metric:"real_world_dhw_efficiency",value:78,units:"percent",source_id:"S6"},
      {category:"system_efficiency",system_type:"reg_vented_cyl",metric:"real_world_dhw_efficiency",value:55,units:"percent",source_id:"S6"},
      {category:"system_efficiency",system_type:"unvented_cyl",metric:"real_world_dhw_efficiency",value:65,units:"percent",source_id:"S7"},
      {category:"system_efficiency",system_type:"any_cyl",metric:"cylinder_standing_loss_modern",value:1.5,units:"kWh/day",source_id:"S3"},
      {category:"system_efficiency",system_type:"old_vented_cyl",metric:"cylinder_standing_loss_old",value:3.5,units:"kWh/day",source_id:"S3"},
      {category:"modulation_benefit",system_type:"regular/unvented",metric:"boiler_effective_efficiency_gain_vs_short_draws",value:3,units:"percent",source_id:"S7"},
      {category:"modulation_benefit",system_type:"combi",metric:"boiler_effective_efficiency_drop_vs_long_burns",value:3,units:"percent",source_id:"S4"},
      {category:"ongoing_costs",system_type:"system",metric:"annualised_extra_service_cost",value:20,units:"GBP/year",source_id:"S8"},
      {category:"ongoing_costs",system_type:"combi",metric:"annualised_extra_service_cost",value:50,units:"GBP/year",source_id:"S8"}
    ];
    const sourcesList = [
      {id:"S1",title:"UK household water use figures",desc:"149 L/day single, 276 L/day two-person, ~450 L/day four-person"},
      {id:"S2",title:"UK domestic hot water ~4 kWh/day",desc:"~80 L at 55°C per dwelling"},
      {id:"S3",title:"Combi hot water delivery/waste",desc:"5–8 L/draw and 30–90 s for distant taps; cylinders ~1–2 L"},
      {id:"S4",title:"SAP/field combi DHW loss allowance",desc:"~600 kWh/yr + per-draw warm-up and post-purge dumping"},
      {id:"S5",title:"Open-vented vs sealed heating efficiency",desc:"Open-vent loses via F&E; sealed avoids it"},
      {id:"S6",title:"Field efficiencies combi vs cylinder",desc:"Combis 75–82%, cylinders 30–70%"},
      {id:"S7",title:"Unvented cylinders better insulated, longer burns",desc:"Long charge -> better modulation -> higher effective DHW efficiency"},
      {id:"S8",title:"Service/maintenance cost differentials",desc:"Combis cycle more (DHW) so higher annualised cost"}
    ];

    function getRecommendedDraws(people) {
      const p = Number(people);
      if (p <= 1) return 12;
      if (p === 2) return 18;
      if (p === 3) return 22;
      if (p === 4) return 26;
      if (p === 5) return 30;
      return 34;
    }

    function getHouseholdWater(beds) {
      const r = systemPerformanceData.find(i => i.category === "occupancy" && i.bedrooms === beds);
      return r ? r.value : 276;
    }
    function getCombiWaste(houseType) {
      const r = systemPerformanceData.find(i => i.category==="distribution_waste" && i.system_type==="combi" && i.house_type===houseType);
      return r ? r.value : 5.5;
    }
    function getCombiWait(houseType) {
      const r = systemPerformanceData.find(i => i.category==="distribution_waste" && i.system_type==="combi" && i.house_type===houseType && i.metric==="hot_water_wait_time");
      return r ? r.value : 45;
    }
    function getStoredWaste() {
      const r = systemPerformanceData.find(i => i.category==="distribution_waste" && i.system_type==="regular/unvented" && i.metric==="hot_water_waste_per_draw");
      return r ? r.value : 1.5;
    }
    function getStoredWait() {
      const r = systemPerformanceData.find(i => i.category==="distribution_waste" && i.system_type==="regular/unvented" && i.metric==="hot_water_wait_time");
      return r ? r.value : 10;
    }

    const CACHE_BUSTER = "v=20240604";
    const withCacheBuster = (path) => `${path}?${CACHE_BUSTER}`;

    const boilerDiagramMap = {
      regular: {
        src: withCacheBuster("./Data/Open-vented-schematic.jpeg"),
        alt: "Open vented regular boiler schematic"
      },
      system: {
        src: withCacheBuster("./Data/System-boiler.png"),
        alt: "System boiler schematic"
      },
      combi: {
        src: withCacheBuster("./Data/Combination.png"),
        alt: "Combination (combi) boiler schematic"
      }
    };

    function updateSystemDiagram(containerId, boilerType) {
      const holder = document.getElementById(containerId);
      if (!holder) return;
      const diagram = boilerDiagramMap[boilerType];
      if (diagram) {
        holder.innerHTML = `<img src="${diagram.src}" alt="${diagram.alt}" loading="lazy">`;
        holder.style.display = "block";
      } else {
        holder.innerHTML = "";
        holder.style.display = "none";
      }
    }

    const boilerLabels = {
      regular: "Regular boiler",
      system: "System boiler",
      combi: "Combi boiler"
    };
    const waterLabels = {
      open_vented: "Open vented hot water",
      mixergy_open: "Mixergy open vented hot water",
      unvented: "Unvented hot water",
      mixergy_unvented: "Mixergy unvented hot water",
      thermal_store: "Thermal store",
      on_demand: "On-demand hot water"
    };

    function formatSystemLabel(boiler, water) {
      const b = boilerLabels[boiler] || boiler;
      const w = waterLabels[water] || water;
      return `${b} with ${w}`;
    }

    function evaluateOption({houseType, occupants, bathrooms, drawsPerDay, currentBoiler, currentWater, newBoiler, newWater}) {
      const combiWarmup = 0.025;
      const combiDump = 0.015;
      const isCombi = newBoiler === "combi";
      const isUnvented = (newWater === "unvented" || newWater === "mixergy_unvented");
      const isCurrentOpen = (currentWater === "open_vented" || currentWater === "mixergy_open");
      let score = 0;
      let dailyWasteL = 0;
      let dailyOverheadKWh = 0;
      let dailyCylinderLoss = 0;
      let extraCost = 0;
      const bullets = [];

      if (isCombi) {
        const wastePerDraw = getCombiWaste(houseType);
        const waitSeconds = getCombiWait(houseType);
        dailyWasteL = wastePerDraw * drawsPerDay;
        dailyOverheadKWh = (combiWarmup + combiDump) * drawsPerDay;
        bullets.push(`Delay to hot: about ${waitSeconds}s.`);
        bullets.push(`Water wasted per draw ≈ ${wastePerDraw.toFixed(1)} L → daily ≈ ${dailyWasteL.toFixed(1)} L.`);
        bullets.push(`Energy overhead (warm-up + pump overrun) ≈ ${dailyOverheadKWh.toFixed(2)} kWh/day.`);
        if (occupants <= 3 && bathrooms <= 2 && houseType !== "detached") {
          score += 3;
        } else {
          bullets.push("High/simultaneous demand → combi may slow or drop temp.");
          score -= 2;
        }
        if (!isUnvented) {
          bullets.push("Like-for-like combi is usually the lowest install cost.");
          score += 1;
        }
      } else {
        const storedWaste = getStoredWaste();
        const waitStored = getStoredWait();
        dailyWasteL = storedWaste * drawsPerDay;
        dailyCylinderLoss = 1.5;
        bullets.push(`Tap-to-hot typically ≈ ${waitStored}s.`);
        bullets.push(`Water wasted per draw ≈ ${storedWaste.toFixed(1)} L → daily ≈ ${dailyWasteL.toFixed(1)} L.`);
        bullets.push(`Cylinder standing loss ≈ ${dailyCylinderLoss.toFixed(1)} kWh/day.`);
        bullets.push("Longer cylinder charge → boiler can modulate efficiently.");
        score += 3;
      }

      if (isCurrentOpen && isUnvented) {
        extraCost = 2000;
        bullets.push("Open vented → unvented conversion: allow ≈ £2000 extra.");
        score -= 1;
      }

      if (isCombi && currentBoiler !== "combi") {
        extraCost += 1500;
        bullets.push("Changing to a combi: allow ≈ £1500 extra for conversion costs.");
      }

      return {score, bullets, dailyWasteL, dailyOverheadKWh, dailyCylinderLoss, extraCost, isCombi, isUnvented};
    }

    async function render() {
      const houseType = document.getElementById("houseType").value;
      const bedrooms = document.getElementById("bedrooms").value;
      const bathrooms = parseInt(document.getElementById("bathrooms").value, 10);
      const occupants = parseInt(document.getElementById("occupants").value, 10);
      const drawsPerDay = parseInt(document.getElementById("drawsPerDay").value || "22", 10);
      const currentBoiler = document.getElementById("currentBoiler").value;
      const currentWater = document.getElementById("currentWater").value;
      const newABoiler = document.getElementById("newABoiler").value;
      const newAWater = document.getElementById("newAWater").value;
      const newBBoiler = document.getElementById("newBBoiler").value;
      const newBWater = document.getElementById("newBWater").value;

      document.getElementById("picCurrentLabel").textContent = formatSystemLabel(currentBoiler, currentWater);
      document.getElementById("picALabel").textContent = formatSystemLabel(newABoiler, newAWater);
      document.getElementById("picBLabel").textContent = formatSystemLabel(newBBoiler, newBWater);
      updateSystemDiagram("picCurrentDiagram", currentBoiler);
      updateSystemDiagram("picADiagram", newABoiler);
      updateSystemDiagram("picBDiagram", newBBoiler);

      const evalA = evaluateOption({houseType, occupants, bathrooms, drawsPerDay, currentBoiler, currentWater, newBoiler:newABoiler, newWater:newAWater});
      const evalB = evaluateOption({houseType, occupants, bathrooms, drawsPerDay, currentBoiler, currentWater, newBoiler:newBBoiler, newWater:newBWater});

      const bestIsA = evalA.score >= evalB.score;
      const bestTick = document.getElementById("bestTick");
      const secondTick = document.getElementById("secondTick");
      bestTick.classList.add("active");
      secondTick.classList.remove("active");
      bestTick.textContent = "✓";
      secondTick.textContent = "";

      const makeBox = (label, ev) => `
<strong>${label}</strong><br>
• Daily HW wasted: ${ev.dailyWasteL.toFixed(1)} L<br>
${ev.dailyOverheadKWh ? `• DHW overhead: ${ev.dailyOverheadKWh.toFixed(2)} kWh/day<br>` : ""}
${ev.dailyCylinderLoss ? `• Cylinder loss: ${ev.dailyCylinderLoss.toFixed(1)} kWh/day<br>` : ""}
${ev.extraCost ? `• Extra install: ≈ £${ev.extraCost}<br>` : ""}
${ev.bullets.map(b => "• " + b).join("<br>")}
      `;

      const bestBody = document.getElementById("bestBody");
      const secondBody = document.getElementById("secondBody");

      if (bestIsA) {
        bestBody.innerHTML = makeBox(`Solution A: ${formatSystemLabel(newABoiler, newAWater)}`, evalA);
        secondBody.innerHTML = makeBox(`Solution B: ${formatSystemLabel(newBBoiler, newBWater)}`, evalB);
      } else {
        bestBody.innerHTML = makeBox(`Solution B: ${formatSystemLabel(newBBoiler, newBWater)}`, evalB);
        secondBody.innerHTML = makeBox(`Solution A: ${formatSystemLabel(newABoiler, newAWater)}`, evalA);
      }

      const dailyWater = getHouseholdWater(bedrooms);
      const localSummary = `
You: ${houseType}, ${bedrooms} beds, ${bathrooms} baths, ${occupants} people.
Current system: ${formatSystemLabel(currentBoiler, currentWater)}.
Typical water for this size: ~${dailyWater} L/day.
Hot-water draws modelled: ${drawsPerDay} per day.

Solution A (${formatSystemLabel(newABoiler, newAWater)})
- Hot-water wasted: ${evalA.dailyWasteL.toFixed(1)} L/day
${evalA.dailyOverheadKWh ? `- Energy overhead from combi start/stop: ${evalA.dailyOverheadKWh.toFixed(2)} kWh/day\n` : ""}${evalA.dailyCylinderLoss ? `- Cylinder standing loss: ${evalA.dailyCylinderLoss.toFixed(1)} kWh/day\n` : ""}${evalA.extraCost ? `- Extra install allowance: ≈ £${evalA.extraCost}\n` : ""}- Notes: ${evalA.bullets.join("; ")}

Solution B (${formatSystemLabel(newBBoiler, newBWater)})
- Hot-water wasted: ${evalB.dailyWasteL.toFixed(1)} L/day
${evalB.dailyOverheadKWh ? `- Energy overhead from combi start/stop: ${evalB.dailyOverheadKWh.toFixed(2)} kWh/day\n` : ""}${evalB.dailyCylinderLoss ? `- Cylinder standing loss: ${evalB.dailyCylinderLoss.toFixed(1)} kWh/day\n` : ""}${evalB.extraCost ? `- Extra install allowance: ≈ £${evalB.extraCost}\n` : ""}- Notes: ${evalB.bullets.join("; ")}

Best match for what you entered: ${bestIsA ? "Solution A" : "Solution B"}.
      `.trim();

      let finalSummary = localSummary;
      try {
        const resp = await fetch("https://survey-brain-api.martinbibb.workers.dev", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            task: "rephrase_system_summary",
            inputs: {
              houseType, bedrooms, bathrooms, occupants, drawsPerDay,
              current: {boiler: currentBoiler, water: currentWater},
              solutionA: {boiler: newABoiler, water: newAWater, metrics: evalA},
              solutionB: {boiler: newBBoiler, water: newBWater, metrics: evalB},
              localSummary
            }
          })
        });
        if (resp.ok) {
          const data = await resp.json();
          if (data && data.summary) {
            finalSummary = data.summary;
          }
        }
      } catch(e) {
        // ignore if API down
      }

      document.getElementById("summary-text").textContent = finalSummary;
    }

    document.querySelectorAll("select,input").forEach(el => {
      if (el.id === "occupants") return;
      el.addEventListener("input", render);
    });

    document.getElementById("occupants").addEventListener("input", (e) => {
      const rec = getRecommendedDraws(e.target.value);
      const draws = document.getElementById("drawsPerDay");
      draws.value = rec;
      render();
    });

    document.getElementById("btn-print").addEventListener("click", () => window.print());
    document.getElementById("btn-sources").addEventListener("click", () => {
      window.open("https://github.com/martinbibb-cmd/System-recommendation", "_blank");
    });
    document.getElementById("btn-export-data").addEventListener("click", () => {
      const headers = ["category","sub_category","system_type","house_type","bedrooms","metric","value","units","source_id","notes"];
      const lines = [headers.join(",")];
      systemPerformanceData.forEach(row => {
        const line = [
          row.category || "",
          row.sub_category || "",
          row.system_type || "",
          row.house_type || "",
          row.bedrooms || "",
          row.metric || "",
          row.value !== undefined ? row.value : "",
          row.units || "",
          row.source_id || "",
          row.notes || ""
        ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(",");
        lines.push(line);
      });
      const blob = new Blob([lines.join("\n")], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "system_performance_data.csv";
      a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById("btn-export-sources").addEventListener("click", () => {
      const headers = ["source_id","reference_title","description"];
      const lines = [headers.join(",")];
      sourcesList.forEach(s => {
        const line = [`"${s.id}"`,`"${s.title.replace(/"/g,'""')}"`,`"${s.desc.replace(/"/g,'""')}"`].join(",");
        lines.push(line);
      });
      const blob = new Blob([lines.join("\n")], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "sources.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    // initial
    render();
  </script>
</body>
</html>
