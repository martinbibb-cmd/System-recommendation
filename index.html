<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>System Recommendation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f8fafc;
      --fg: #0f172a;
      --card: #ffffff;
      --border: #e2e8f0;
      --accent: #0ea5e9;
      --muted: #64748b;
      --good: #22c55e;
      --warn: #f97316;
    }
    * { box-sizing: border-box; }
    body, body * {
      font-size: 22pt !important;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: .75rem 1rem .5rem;
      text-align: center;
      background: #fff;
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }
    header small {
      display: block;
      font-size: .65rem;
      color: var(--muted);
    }
    .top-actions {
      position: absolute;
      right: 1rem;
      top: .55rem;
      display: flex;
      gap: .4rem;
    }
    .btn {
      background: var(--accent);
      border: none;
      color: #fff;
      padding: .35rem .6rem;
      border-radius: .5rem;
      font-size: .63rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn.secondary {
      background: #fff;
      border: 1px solid var(--border);
      color: #0f172a;
    }
    main {
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      flex: 1;
      min-height: 0;
    }
    aside {
      background: #f1f5f9;
      border-right: 1px solid var(--border);
      padding: .5rem .5rem 3rem;
      overflow-y: auto;
    }
    .nav-title {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .04em;
      margin: .5rem 0 .25rem;
      color: #475569;
    }
    .panel {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: .6rem;
      margin-bottom: .5rem;
      padding: .5rem .5rem .25rem;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: .2rem;
      font-size: .65rem;
      margin-bottom: .35rem;
    }
    select, input {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: .4rem;
      padding: .25rem .35rem;
      font-size: .65rem;
    }
    #right {
      padding: .5rem .75rem 1rem;
      overflow-y: auto;
    }
    /* list view */
    .result-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: .6rem;
      padding: .6rem .7rem;
      margin-bottom: .6rem;
      display: flex;
      gap: .75rem;
      line-height: 1.3;
      align-items: flex-start;
    }
    .result-image {
      width: 140px;
      border: 1px solid #dbeafe;
      background: #eff6ff;
      border-radius: .6rem;
      flex: 0 0 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: .35rem;
      font-size: .5em;
      color: #475569;
      text-align: center;
      padding: .45rem;
    }
    .result-image img {
      width: 100%;
      height: auto;
      border-radius: .4rem;
      object-fit: contain;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      background: #fff;
    }
    .result-image-label {
      display: flex;
      flex-direction: column;
      gap: .1rem;
      font-size: .45em;
      line-height: 1.25;
    }
    .result-image-boiler {
      font-weight: 700;
      letter-spacing: .01em;
    }
    .result-image-water {
      color: #64748b;
      font-weight: 500;
    }
    .result-body {
      flex: 1;
      min-width: 0;
    }
    .result-header {
      display: flex;
      gap: .5rem;
      align-items: center;
      margin-bottom: .25rem;
    }
    .result-title {
      font-weight: 700;
      font-size: .55em;
    }
    .tick {
      width: 1.3em;
      height: 1.3em;
      border-radius: 9999px;
      background: #e2e8f0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .45em;
      flex: 0 0 auto;
    }
    .tick.active {
      background: #dcfce7;
      color: #166534;
      border: .1em solid #22c55e;
    }
    .why {
      font-size: .45em;
      margin-bottom: .35rem;
      color: #0f172a;
    }
    .list-cols {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .pros, .cons {
      font-size: .45em;
      min-width: 220px;
    }
    .pros h4, .cons h4 {
      margin: 0 0 .2rem;
      font-size: .7em;
    }
    .pros ul, .cons ul {
      margin: 0;
      padding-left: 1.1rem;
    }
    .pros li, .cons li {
      margin-bottom: .15rem;
    }
    .highlight {
      background: #fef3c7;
      border-radius: .3rem;
      padding: .05rem .35rem;
    }
    #summary-disclaimer {
      font-size: .38em;
      color: #475569;
      margin-top: .4rem;
    }
    @media (max-width: 950px) {
      main { grid-template-columns: 1fr; }
      .result-card { flex-direction: column; }
      .result-image { width: 100%; }
      .top-actions { position: static; justify-content: center; margin-top: .4rem; }
      header { padding-top: 2.2rem; }
    }
    @media print {
      header, aside, .top-actions { display: none !important; }
      main { grid-template-columns: 1fr !important; }
      body { background: #fff; }
    }
  </style>
</head>
<body>
  <header>
    <div class="top-actions">
      <button class="btn secondary" id="btn-export-data">Data CSV</button>
      <button class="btn secondary" id="btn-export-sources">Sources CSV</button>
      <button class="btn" id="btn-print">Print / PDF</button>
    </div>
    <h1>Which system is best for you?</h1>
    <small>UK, evidence-based, illustrative only.</small>
  </header>
  <main>
    <aside>
      <div class="nav-title">About you</div>
      <div class="panel">
        <label>
          House type
          <select id="houseType">
            <option value="flat/bungalow">Flat / Bungalow</option>
            <option value="terraced">Terraced</option>
            <option value="semi" selected>Semi-detached</option>
            <option value="detached">Detached</option>
          </select>
        </label>
        <label>
          Bedrooms
          <select id="bedrooms">
            <option>1</option>
            <option>2</option>
            <option selected>3</option>
            <option>4</option>
            <option>5</option>
          </select>
        </label>
        <label>
          Bathrooms
          <select id="bathrooms">
            <option>1</option>
            <option selected>2</option>
            <option>3</option>
          </select>
        </label>
        <label>
          People in home
          <select id="occupants">
            <option>1</option>
            <option>2</option>
            <option selected>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
          </select>
        </label>
        <label>
          Hot draws per day
          <input type="number" id="drawsPerDay" value="22" min="5" max="60" />
          <small style="color:#94a3b8;">Auto-adjusts with people, can override.</small>
        </label>
      </div>

      <div class="nav-title">Current system</div>
      <div class="panel">
        <label>
          Boiler type
          <select id="currentBoiler">
            <option value="regular">Regular</option>
            <option value="system">System</option>
            <option value="combi" selected>Combi</option>
          </select>
        </label>
        <label>
          Water
          <select id="currentWater">
            <option value="open_vented">Open vented</option>
            <option value="mixergy_open">Mixergy open vented</option>
            <option value="unvented">Unvented</option>
            <option value="mixergy_unvented">Mixergy unvented</option>
            <option value="thermal_store">Thermal store</option>
            <option value="on_demand">On demand</option>
          </select>
        </label>
      </div>

      <div class="nav-title">Potential solution A</div>
      <div class="panel">
        <label>
          Boiler
          <select id="newABoiler">
            <option value="regular">Regular</option>
            <option value="system">System</option>
            <option value="combi" selected>Combi</option>
          </select>
        </label>
        <label>
          Water
          <select id="newAWater">
            <option value="open_vented">Open vented</option>
            <option value="mixergy_open">Mixergy open vented</option>
            <option value="unvented">Unvented</option>
            <option value="mixergy_unvented">Mixergy unvented</option>
            <option value="on_demand">On demand</option>
          </select>
        </label>
      </div>

      <div class="nav-title">Potential solution B</div>
      <div class="panel">
        <label>
          Boiler
          <select id="newBBoiler">
            <option value="regular">Regular</option>
            <option value="system">System</option>
            <option value="combi">Combi</option>
          </select>
        </label>
        <label>
          Water
          <select id="newBWater">
            <option value="open_vented">Open vented</option>
            <option value="mixergy_open">Mixergy open vented</option>
            <option value="unvented">Unvented</option>
            <option value="mixergy_unvented">Mixergy unvented</option>
            <option value="on_demand">On demand</option>
          </select>
        </label>
      </div>
    </aside>

    <div id="right">
      <!-- results will be injected here -->
      <div id="results"></div>
      <div id="in-depth-summary" style="background:#fff;border:1px solid #e2e8f0;border-radius:.6rem;padding:.55rem .7rem;margin-bottom:.6rem;font-size:.55rem;line-height:1.4;"></div>
      <div id="summary-disclaimer">
        This illustration is for guidance only and does not constitute financial advice, a quotation, or a heating system design.
        Figures are derived from UK field research (2015–2025) on domestic water use, DHW efficiency, combi lag, cylinder losses, and installer-reported performance.
        Values are indicative and should be confirmed by an on-site survey.
      </div>
    </div>
  </main>

  <script>
    // data (same as before, trimmed for brevity)
    const boilerLabels = {
      regular: "Regular",
      system: "System",
      combi: "Combi"
    };

    const boilerImages = {
      regular: "Data/Open-vented-schematic.jpeg",
      system: "Data/System-boiler.png",
      combi: "Data/Combination.png"
    };

    const waterLabels = {
      open_vented: "Open vented",
      mixergy_open: "Mixergy open vented",
      unvented: "Unvented",
      mixergy_unvented: "Mixergy unvented",
      thermal_store: "Thermal store",
      on_demand: "On demand"
    };

    const systemData = {
      combi: {
        baseWaste: {
          "flat/bungalow": 1,
          "terraced": 5.5,
          "semi": 5.5,
          "detached": 8
        },
        baseWait: {
          "flat/bungalow": 20,
          "terraced": 45,
          "semi": 45,
          "detached": 90
        },
        startupKWh: 0.025,
        postPurgeKWh: 0.015
      },
      stored: {
        wastePerDraw: 1.5,
        wait: 10,
        cylLoss: 1.5
      }
    };

    const sourcesList = [
      "Energy Saving Trust / BEIS domestic HW studies (2016–2023)",
      "SAP / BRE space & water efficiency assumptions",
      "Waterwise / OFWAT UK household water use",
      "Installer field data on combi lag and post-purge",
      "UK open-vented vs sealed system practice"
    ];

    function isOpenVentedWater(w) {
      return w === "open_vented" || w === "mixergy_open";
    }
    function isSealedWater(w) {
      return w === "unvented" || w === "mixergy_unvented";
    }
    function isCombiBoiler(b) {
      return b === "combi";
    }

    // science-based profiles
    const systemProfiles = {
      combi_on_demand: {
        label: "Combi Boiler",
        efficiency: "83–86%",
        installCost: "Relative install cost: Low (baseline for like-for-like swaps)",
        space: "No cylinder",
        lifespan: "10–12 years",
        maintenance: 4,
        hotWater: "Instantaneous, but one outlet ~6–10 L/min typical",
        pressure: "Needs good mains (>1.5 bar, >14 L/min)",
        renewables: "Poor – no store for solar / HP",
        strengths: [
          "Compact, no tanks or cylinder",
          "Low standing losses",
          "Good for flats/small 1-bath with strong mains"
        ],
        limitations: [
          "Designed for one tap/shower at a time",
          "High water waste and cycling losses vs stored",
          "Shorter life vs stored systems",
          "Needs bigger gas than a 15 kW regular"
        ],
        bestFor: "Flats, small 1-bath homes with strong mains"
      },
      system_unvented: {
        label: "System Boiler (Unvented)",
        efficiency: "88–91%",
        installCost: "Relative install cost: Medium-high (cylinder + safety kit)",
        space: "Needs cylinder / airing cupboard",
        lifespan: "15–20 years",
        maintenance: 3,
        hotWater: "Stored, mains pressure, good multi-outlet",
        pressure: "Needs good mains pressure",
        renewables: "Excellent – PV, Mixergy, heat pumps",
        strengths: [
          "High performance, balanced pressure",
          "Supports multiple outlets/bathrooms",
          "Future-proof: solar / PV / HP ready",
          "Holds real-world efficiency near ≈94%"
        ],
        limitations: [
          "Higher install cost",
          "Needs space for cylinder and discharge",
          "G3 service/annual maintenance"
        ],
        bestFor: "Modern 2–4 bed homes with 1–2 baths"
      },
      regular_open: {
        label: "Regular Boiler (Open-Vented)",
        efficiency: "86–89%",
        installCost: "Relative install cost: Low-medium (staying vented keeps costs down)",
        space: "Loft tank + airing cupboard",
        lifespan: "15–25 years",
        maintenance: 2,
        hotWater: "Stored, gravity or pumped (low pressure)",
        pressure: "Works with poor mains",
        renewables: "Good with solar coil / vented Mixergy",
        strengths: [
          "Simple, tolerant, long life",
          "Good for poor mains / rural",
          "Low maintenance"
        ],
        limitations: [
          "Low pressure unless pumped",
          "Tanks in loft",
          "Less efficient than unvented in practice"
        ],
        bestFor: "Older houses, rural or low-pressure areas"
      },
      mixergy_open: {
        label: "Mixergy – Open-Vented (Smart Cylinder + Regular)",
        efficiency: "87–90%",
        installCost: "Relative install cost: Medium-high (smart cylinder premium)",
        space: "Vented cylinder + loft tank",
        lifespan: "20–25 years",
        maintenance: 3,
        hotWater: "Stored, stratified, gravity or pumped",
        pressure: "Works with poor mains",
        renewables: "Excellent – PV / boiler / HP compatible",
        strengths: [
          "Smart control, partial heat saves energy",
          "Stays vented → gentle on old pipework",
          "PV and future HP friendly"
        ],
        limitations: [
          "Still vented – needs loft tank & pump for power showers",
          "Higher capital than plain vented",
          "Needs space"
        ],
        bestFor: "Upgraded vented systems, low-pressure areas wanting smart control"
      },
      mixergy_unvented: {
        label: "Mixergy – Unvented (Smart Cylinder + System)",
        efficiency: "89–92%",
        installCost: "Relative install cost: High (premium smart unvented setup)",
        space: "Unvented cylinder",
        lifespan: "20–25 years",
        maintenance: 3,
        hotWater: "Stored, mains pressure, multi-outlet",
        pressure: "Needs strong mains",
        renewables: "Excellent – PV, HP, dynamic tariffs",
        strengths: [
          "High performance, future-proof",
          "Smart energy savings",
          "Mains pressure hot water"
        ],
        limitations: [
          "High capital cost",
          "G3 requirements",
          "Needs good mains pressure"
        ],
        bestFor: "Modern medium-large homes, multi-bath setups"
      }
    };

    // map boiler+water → profile key
    function pickSystemProfile(boiler, water) {
      if (boiler === "combi") return "combi_on_demand";
      if (boiler === "system" && water === "unvented") return "system_unvented";
      if (boiler === "system" && water === "mixergy_unvented") return "mixergy_unvented";
      if (boiler === "regular" && (water === "open_vented")) return "regular_open";
      if (boiler === "regular" && (water === "mixergy_open")) return "mixergy_open";
      // sensible fallbacks
      if (boiler === "system") return "system_unvented";
      if (boiler === "regular") return "regular_open";
      return "combi_on_demand";
    }

    function renderInDepthSummary(options, ctx) {
      const box = document.getElementById("in-depth-summary");
      if (!box) return;

      const best = options[0];
      const second = options[1];

      if (!best) {
        box.textContent = "";
        return;
      }

      const bestProfile = systemProfiles[pickSystemProfile(best.boiler, best.water)] || systemProfiles.combi_on_demand;
      const secondProfile = second
        ? systemProfiles[pickSystemProfile(second.boiler, second.water)] || systemProfiles.combi_on_demand
        : null;

      const comingFromOpen = ctx.currentWater === "open_vented" || ctx.currentWater === "mixergy_open";

      const parts = [];

      parts.push("Explanation of the two options");
      parts.push("");

      // BEST
      parts.push(`1) ${bestProfile.label}`);
      parts.push(`• What it is: ${bestProfile.hotWater}.`);
      parts.push(`• Efficiency (real): ${bestProfile.efficiency}; install typically ${bestProfile.installCost}.`);
      parts.push(`• Strengths: ${bestProfile.strengths.join("; ")}.`);
      parts.push(`• Limitations: ${bestProfile.limitations.join("; ")}.`);
      if (comingFromOpen && (best.boiler === "combi" || best.boiler === "system" || best.water === "unvented" || best.water === "mixergy_unvented")) {
        parts.push("• Because you are currently open vented, moving to this sealed/high-pressure option can expose minor existing leaks/weeps.");
      }
      parts.push("");

      // SECOND
      if (second && secondProfile) {
        parts.push(`2) ${secondProfile.label}`);
        parts.push(`• What it is: ${secondProfile.hotWater}.`);
        parts.push(`• Efficiency (real): ${secondProfile.efficiency}; install typically ${secondProfile.installCost}.`);
        parts.push(`• Strengths: ${secondProfile.strengths.join("; ")}.`);
        parts.push(`• Limitations: ${secondProfile.limitations.join("; ")}.`);
        if (comingFromOpen && (second.boiler === "combi" || second.boiler === "system" || second.water === "unvented" || second.water === "mixergy_unvented")) {
          parts.push("• As above, pressurising an old open-vented system can highlight existing weeps.");
        }
        parts.push("");
      }

      // CLEAR DISCLAIMER
      parts.push("Disclaimer: This comparison is illustrative and based on typical UK domestic installs. Actual suitability, costs, and G3/unvented requirements must be confirmed by an on-site survey and installer/designer. Mains pressure must be measured before committing to a combi or unvented solution.");

      box.textContent = parts.join("\n");
    }

    function getRecommendedDraws(people) {
      const p = Number(people);
      if (p <= 1) return 12;
      if (p === 2) return 18;
      if (p === 3) return 22;
      if (p === 4) return 26;
      if (p === 5) return 30;
      return 34;
    }

    function evaluateOption({houseType, occupants, bathrooms, drawsPerDay, currentBoiler, currentWater, newBoiler, newWater}) {
      const isCombi = newBoiler === "combi";
      const isStored = newWater === "unvented" || newWater === "mixergy_unvented" || newWater === "open_vented" || newWater === "mixergy_open" || newWater === "on_demand";
      const isCurrentStored = currentWater !== "on_demand" && currentWater !== "unvented" ? true : (currentWater !== "on_demand");
      const isCurrentOpen = currentWater === "open_vented" || currentWater === "mixergy_open";

      let score = 0;
      let dailyWasteL = 0;
      let dailyOverheadKWh = 0;
      let dailyCylinderLoss = 0;
      const pros = [];
      const cons = [];
      const relevant = new Set();

      // performance
      if (isCombi) {
        const wastePerDraw = systemData.combi.baseWaste[houseType] ?? 5.5;
        const wait = systemData.combi.baseWait[houseType] ?? 45;
        dailyWasteL = wastePerDraw * drawsPerDay;
        dailyOverheadKWh = (systemData.combi.startupKWh + systemData.combi.postPurgeKWh) * drawsPerDay;
        pros.push("Single appliance, frees space");
        cons.push(`Hot water lag ${wait}s to tap`);
        cons.push(`Wastes about ${wastePerDraw.toFixed(1)} L per draw (${dailyWasteL.toFixed(1)} L/day)`);
        cons.push(`Per-draw energy overhead ≈ ${dailyOverheadKWh.toFixed(2)} kWh/day`);
        // suitability
        if (occupants <= 3 && bathrooms <= 2) {
          score += 3;
          relevant.add("pros:Single appliance, frees space");
        } else {
          score -= 2;
          relevant.add(`cons:Hot water lag ${wait}s to tap`);
        }
      } else {
        // stored / cylinder
        dailyWasteL = systemData.stored.wastePerDraw * drawsPerDay;
        dailyCylinderLoss = systemData.stored.cylLoss;
        pros.push("Shorter tap-to-hot, better comfort");
        pros.push("Longer boiler burns → better modulation");
        cons.push(`Cylinder standing loss ≈ ${dailyCylinderLoss.toFixed(1)} kWh/day`);
        score += 3;
        if (occupants >= 4 || bathrooms >= 2) {
          pros.push("Better for multiple/simultaneous draws");
          score += 2;
          relevant.add("pros:Better for multiple/simultaneous draws");
        }
      }

      // cost / disruption
      // 1) open vented → unvented
      if (isCurrentOpen && (newWater === "unvented" || newWater === "mixergy_unvented")) {
        cons.push("Open-vented → unvented typically adds a notable premium for upgrade work");
        score -= 1;
        relevant.add("cons:Open-vented → unvented typically adds a notable premium for upgrade work");
      }
      // 2) stored → combi (common UK reality: noticeable extra labour/material)
      if (newBoiler === "combi" && currentBoiler !== "combi") {
        cons.push("Converting to a combi from stored often adds a noticeable premium for pipework and cylinder removal");
        score -= 1;
        relevant.add("cons:Converting to a combi from stored often adds a noticeable premium for pipework and cylinder removal");
      }
      // 3) like-for-like
      if (newBoiler === currentBoiler && newWater === currentWater) {
        pros.push("Like-for-like keeps cost and disruption low");
        score += 2;
        relevant.add("pros:Like-for-like keeps cost and disruption low");
      }

      return {
        score,
        dailyWasteL,
        dailyOverheadKWh,
        dailyCylinderLoss,
        pros,
        cons,
        relevant
      };
    }

    async function render() {
      const houseType = document.getElementById("houseType").value;
      const bedrooms = document.getElementById("bedrooms").value;
      const bathrooms = parseInt(document.getElementById("bathrooms").value, 10);
      const occupants = parseInt(document.getElementById("occupants").value, 10);
      const drawsPerDay = parseInt(document.getElementById("drawsPerDay").value, 10);
      const currentBoiler = document.getElementById("currentBoiler").value;
      const currentWater = document.getElementById("currentWater").value;
      const newABoiler = document.getElementById("newABoiler").value;
      const newAWater = document.getElementById("newAWater").value;
      const newBBoiler = document.getElementById("newBBoiler").value;
      const newBWater = document.getElementById("newBWater").value;

      const evalA = evaluateOption({houseType, occupants, bathrooms, drawsPerDay, currentBoiler, currentWater, newBoiler:newABoiler, newWater:newAWater});
      const evalB = evaluateOption({houseType, occupants, bathrooms, drawsPerDay, currentBoiler, currentWater, newBoiler:newBBoiler, newWater:newBWater});

      // pick best
      const options = [
        {
          id: "A",
          title: `Option A: ${formatBoilerName(newABoiler)} + ${formatWaterName(newAWater)}`,
          boiler: newABoiler,
          boilerLabel: formatBoilerName(newABoiler),
          water: newAWater,
          waterLabel: formatWaterName(newAWater),
          ...evalA
        },
        {
          id: "B",
          title: `Option B: ${formatBoilerName(newBBoiler)} + ${formatWaterName(newBWater)}`,
          boiler: newBBoiler,
          boilerLabel: formatBoilerName(newBBoiler),
          water: newBWater,
          waterLabel: formatWaterName(newBWater),
          ...evalB
        }
      ].sort((a,b) => b.score - a.score); // best first

      const bestId = options[0].id;

      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = options.map(opt => {
        const why = makeWhyText(opt, occupants, bathrooms);
        return makeResultCard(opt, why, opt.id === bestId);
      }).join("");

      // in-depth summary based on both options and the current system
      renderInDepthSummary(options, {
        currentWater,
        currentBoiler,
        bathrooms,
        occupants
      });
    }

    function makeWhyText(opt, occupants, bathrooms) {
      // short explanation
      if (opt.boiler === "combi") {
        if (occupants <= 3 && bathrooms <= 2) {
          return "Works for your size household, but expect some hot-water lag and per-draw energy overhead.";
        }
        return "Will work, but your usage suggests stored water would reduce lag and wasted water.";
      } else {
        return "Stored hot water suits your household because it reduces wait time and copes better with multiple uses.";
      }
    }

    function makeResultCard(opt, why, isBest) {
      // get profile
      const profileKey = pickSystemProfile(opt.boiler, opt.water);
      const profile = systemProfiles[profileKey] || systemProfiles.combi_on_demand;

      // relevance logic
      const currentWater = document.getElementById("currentWater").value;
      const comingFromOpen = currentWater === "open_vented" || currentWater === "mixergy_open";
      const targetIsSealed =
        opt.boiler === "combi" ||
        opt.boiler === "system" ||
        opt.water === "unvented" ||
        opt.water === "mixergy_unvented";

      // build pros/cons from profile
      const prosHtml = (profile.strengths || []).map(p => {
        let highlight = false;
        // highlight future-proof if system/mixergy
        if (p.toLowerCase().includes("future") || p.toLowerCase().includes("pv")) {
          highlight = true;
        }
        // highlight “works with poor mains” if current is open vented
        if (comingFromOpen && p.toLowerCase().includes("poor mains")) {
          highlight = true;
        }
        return `<li${highlight ? ' class="highlight"' : ''}>${p}</li>`;
      }).join("");

      const consArray = profile.limitations ? [...profile.limitations] : [];

      // add dynamic cons
      if (comingFromOpen && targetIsSealed) {
        consArray.push("Converting from open vented to sealed/high pressure can expose minor existing leaks/weeps.");
      }
      if (opt.boiler === "combi") {
        consArray.push("Designed for one tap/shower at a time; performance follows mains.");
        consArray.push("Combi will usually need a bigger gas supply than a 15 kW regular.");
      }

      const consHtml = consArray.map(c => {
        let highlight = false;
        if (c.toLowerCase().includes("leak") || c.toLowerCase().includes("sealed")) {
          highlight = true;
        }
        if (c.toLowerCase().includes("mains") && currentWater === "open_vented") {
          highlight = true;
        }
        return `<li${highlight ? ' class="highlight"' : ''}>${c}</li>`;
      }).join("");

      return `
      <div class="result-card">
        <div class="result-image">
          ${renderBoilerImage(opt)}
          <div class="result-image-label">
            <span class="result-image-boiler">${profile.label}</span>
            <span class="result-image-water">${formatWaterName(opt.water)}</span>
          </div>
        </div>
        <div class="result-body">
          <div class="result-header">
            <div class="tick ${isBest ? 'active' : ''}">${isBest ? '✓' : ''}</div>
            <div class="result-title">${opt.title}</div>
          </div>
          <div class="why">${why}</div>
          <div class="list-cols">
            <div class="pros">
              <h4>Pros</h4>
              <ul>
                ${prosHtml || "<li>No major pros recorded.</li>"}
              </ul>
            </div>
            <div class="cons">
              <h4>Cons</h4>
              <ul>
                ${consHtml || "<li>No major cons recorded.</li>"}
              </ul>
            </div>
          </div>
          <div style="font-size:.4em;color:#475569;margin-top:.35rem;">
            Seasonal/real-world efficiency: ${profile.efficiency} · Install cost: ${profile.installCost} · Space: ${profile.space} · Lifespan: ${profile.lifespan} · Best suited: ${profile.bestFor}
          </div>
        </div>
      </div>
      `;
    }

    function renderBoilerImage(opt) {
      const src = boilerImages[opt.boiler];
      if (!src) {
        return "";
      }
      const alt = `${opt.boilerLabel} boiler illustration`;
      return `<img src="${src}" alt="${alt}" />`;
    }

    function formatBoilerName(value) {
      return boilerLabels[value] || value;
    }

    function formatWaterName(value) {
      return waterLabels[value] || value.replace(/_/g, " ");
    }

    // events
    document.querySelectorAll("select,input").forEach(el => el.addEventListener("input", render));
    document.getElementById("occupants").addEventListener("input", e => {
      const rec = getRecommendedDraws(e.target.value);
      const draws = document.getElementById("drawsPerDay");
      draws.value = rec;
      render();
    });
    document.getElementById("btn-print").addEventListener("click", () => window.print());
    document.getElementById("btn-export-data").addEventListener("click", () => {
      alert("In this cut-down version, CSV export is stubbed. Use previous version's CSV section to keep data + sources.");
    });
    document.getElementById("btn-export-sources").addEventListener("click", () => {
      alert("Sources used:\n- " + sourcesList.join("\n- "));
    });

    render();
  </script>
</body>
</html>